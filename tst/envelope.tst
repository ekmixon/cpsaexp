(herald "Envelope Protocol" (bound 50))

(comment "CPSA 4.1.1")
(comment "All input read from envelope.scm")
(comment "Strand count bounded at 50")

(defprotocol envelope basic
  (defrole tpm-power-on
    (vars (pcrkey skey))
    (trace (recv "power on") (send (enc "0" (hash pcrkey))))
    (non-orig pcrkey))
  (defrole tpm-extend
    (vars (value current-value mesg) (pcrkey skey))
    (trace (recv (cat "extend" value))
      (recv (enc current-value (hash pcrkey)))
      (send (enc (hash current-value value) (hash pcrkey)))
      (send "ext ok"))
    (non-orig pcrkey))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcrkey esk skey))
    (trace (recv (enc "extend" value esk))
      (recv (enc current-value (hash pcrkey)))
      (send (enc (hash current-value value) (hash pcrkey)))
      (send "ext ok"))
    (non-orig pcrkey esk))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcrkey skey) (aik akey))
    (trace (recv (cat "quote" nonce))
      (recv (enc current-value (hash pcrkey)))
      (send (enc "quote" current-value nonce aik)))
    (non-orig pcrkey aik))
  (defrole tpm-create-key
    (vars (k aik akey) (pcrval mesg) (esk skey))
    (trace (recv (enc "create key" pcrval esk))
      (send (enc "created" k pcrval aik)))
    (non-orig esk aik (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m pcrvals mesg) (k aik akey) (pcrkey skey))
    (trace (recv (cat "decrypt" (enc m k)))
      (recv (enc "created" k pcrvals aik))
      (recv (enc pcrvals (hash pcrkey))) (send m))
    (non-orig pcrkey aik))
  (defrole alice
    (vars (n v data) (esk skey) (k aik akey))
    (trace (send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    (non-orig esk aik)
    (uniq-orig n v)))

(defskeleton envelope
  (vars (v n data) (esk skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (non-orig esk aik)
  (uniq-orig v n)
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k))))
  (label 0)
  (unrealized (0 0) (1 2))
  (preskeleton)
  (comment "Not a skeleton"))

(defskeleton envelope
  (vars (v n data) (esk skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (precedes ((1 3) (0 0)))
  (non-orig esk aik)
  (uniq-orig v n)
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k))))
  (label 1)
  (parent 0)
  (unrealized (1 2))
  (origs (v (1 3)) (n (1 0)))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (v n data) (esk esk-0 skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk-0) (k k) (aik aik))
  (precedes ((1 3) (0 0)) ((2 1) (1 2)))
  (non-orig esk esk-0 aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-strand tpm-create-key 2)
    (enc "created" k (hash (hash "0" n) "obtain") aik) (1 2))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk-0))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik))))
  (label 2)
  (parent 1)
  (unrealized (0 0) (2 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (v n data) (esk skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (precedes ((1 1) (2 0)) ((1 3) (0 0)) ((2 1) (1 2)))
  (non-orig esk aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (displaced 3 1 alice 2)
    (enc "create key" (hash (hash "0" n) "obtain") esk-0) (2 0))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik))))
  (label 3)
  (parent 2)
  (unrealized (0 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (pcrvals mesg) (v n data) (esk pcrkey skey) (k aik aik-0 akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals pcrvals) (pcrkey pcrkey) (k k)
    (aik aik-0))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 3) (0 0)))
  (non-orig esk pcrkey aik aik-0 (invk k))
  (uniq-orig v n k)
  (operation nonce-test (added-strand tpm-decrypt 4) v (0 0) (enc v k))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k pcrvals aik-0))
      (recv (enc pcrvals (hash pcrkey))) (send v)))
  (label 4)
  (parent 3)
  (unrealized (3 1) (3 2))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 3) (0 0)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (displaced 4 2 tpm-create-key 2)
    (enc "created" k pcrvals aik-0) (3 1))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v)))
  (label 5)
  (parent 4)
  (unrealized (3 2))
  (comment "3 in cohort - 3 not yet seen"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 3) (0 0))
    ((4 2) (3 2)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-strand tpm-extend 3)
    (enc (hash (hash "0" n) "obtain") (hash pcrkey)) (3 2))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey)))))
  (label 6)
  (parent 5)
  (unrealized (4 1))
  (comment "3 in cohort - 3 not yet seen"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey esk-0 skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend-enc 3 (value "obtain")
    (current-value (hash "0" n)) (pcrkey pcrkey) (esk esk-0))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 3) (0 0))
    ((4 2) (3 2)))
  (non-orig esk pcrkey esk-0 aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-strand tpm-extend-enc 3)
    (enc (hash (hash "0" n) "obtain") (hash pcrkey)) (3 2))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (enc "extend" "obtain" esk-0))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey)))))
  (label 7)
  (parent 5)
  (unrealized (4 0) (4 1))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (deflistener (hash pcrkey))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 3) (0 0))
    ((4 1) (3 2)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc (hash (hash "0" n) "obtain") (hash pcrkey)) (3 2))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 8)
  (parent 5)
  (unrealized (4 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend 3 (value n) (current-value "0") (pcrkey pcrkey))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 3) (0 0)) ((4 2) (3 2)) ((5 2) (4 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-strand tpm-extend 3)
    (enc (hash "0" n) (hash pcrkey)) (4 1))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (cat "extend" n)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 9)
  (parent 6)
  (unrealized (5 0) (5 1))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey esk-0 skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk-0))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 3) (0 0)) ((4 2) (3 2)) ((5 2) (4 1)))
  (non-orig esk pcrkey esk-0 aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-strand tpm-extend-enc 3)
    (enc (hash "0" n) (hash pcrkey)) (4 1))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk-0)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 10)
  (parent 6)
  (unrealized (5 0) (5 1))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (deflistener (hash pcrkey))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 3) (0 0))
    ((4 2) (3 2)) ((5 1) (4 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc (hash "0" n) (hash pcrkey)) (4 1))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 11)
  (parent 6)
  (unrealized (4 1) (5 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 3) (0 0)) ((4 2) (3 2)) ((5 2) (4 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (displaced 6 1 alice 1)
    (enc "extend" n esk-0) (5 0))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 12)
  (parent 10)
  (unrealized (5 1))
  (comment "2 in cohort - 2 not yet seen"))

(defskeleton envelope
  (vars (v n data) (esk pcrkey skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 3) (0 0)) ((4 2) (3 2)) ((5 2) (4 1)) ((6 1) (5 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-strand tpm-power-on 2)
    (enc "0" (hash pcrkey)) (5 1))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey)))))
  (label 13)
  (parent 12)
  (unrealized)
  (shape)
  (maps ((0 1) ((v v) (n n) (esk esk) (k k) (aik aik))))
  (origs (n (1 0)) (k (2 1)) (v (1 3))))

(defskeleton envelope
  (vars (v n data) (esk pcrkey skey) (k aik akey))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (deflistener (hash pcrkey))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 3) (0 0)) ((4 2) (3 2)) ((5 2) (4 1)) ((6 1) (5 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig v n k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc "0" (hash pcrkey)) (5 1))
  (traces ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 14)
  (parent 12)
  (unrealized (6 0))
  (comment "empty cohort"))

(comment "Nothing left to do")

(defprotocol envelope basic
  (defrole tpm-power-on
    (vars (pcrkey skey))
    (trace (recv "power on") (send (enc "0" (hash pcrkey))))
    (non-orig pcrkey))
  (defrole tpm-extend
    (vars (value current-value mesg) (pcrkey skey))
    (trace (recv (cat "extend" value))
      (recv (enc current-value (hash pcrkey)))
      (send (enc (hash current-value value) (hash pcrkey)))
      (send "ext ok"))
    (non-orig pcrkey))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcrkey esk skey))
    (trace (recv (enc "extend" value esk))
      (recv (enc current-value (hash pcrkey)))
      (send (enc (hash current-value value) (hash pcrkey)))
      (send "ext ok"))
    (non-orig pcrkey esk))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcrkey skey) (aik akey))
    (trace (recv (cat "quote" nonce))
      (recv (enc current-value (hash pcrkey)))
      (send (enc "quote" current-value nonce aik)))
    (non-orig pcrkey aik))
  (defrole tpm-create-key
    (vars (k aik akey) (pcrval mesg) (esk skey))
    (trace (recv (enc "create key" pcrval esk))
      (send (enc "created" k pcrval aik)))
    (non-orig esk aik (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m pcrvals mesg) (k aik akey) (pcrkey skey))
    (trace (recv (cat "decrypt" (enc m k)))
      (recv (enc "created" k pcrvals aik))
      (recv (enc pcrvals (hash pcrkey))) (send m))
    (non-orig pcrkey aik))
  (defrole alice
    (vars (n v data) (esk skey) (k aik akey))
    (trace (send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    (non-orig esk aik)
    (uniq-orig n v)))

(defskeleton envelope
  (vars (n v data) (esk skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (non-orig esk aik)
  (uniq-orig n v)
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k))))
  (label 15)
  (unrealized (0 0) (1 2))
  (preskeleton)
  (comment "Not a skeleton"))

(defskeleton envelope
  (vars (n v data) (esk skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (precedes ((1 3) (0 0)))
  (non-orig esk aik)
  (uniq-orig n v)
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k))))
  (label 16)
  (parent 15)
  (unrealized (0 0) (1 2))
  (origs (v (1 3)) (n (1 0)))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk esk-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk-0) (k k) (aik aik))
  (precedes ((1 3) (0 0)) ((2 1) (1 2)))
  (non-orig esk esk-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-create-key 2)
    (enc "created" k (hash (hash "0" n) "obtain") aik) (1 2))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk-0))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik))))
  (label 17)
  (parent 16)
  (unrealized (0 0) (2 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (precedes ((1 1) (2 0)) ((1 3) (0 0)) ((2 1) (1 2)))
  (non-orig esk aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (displaced 3 1 alice 2)
    (enc "create key" (hash (hash "0" n) "obtain") esk-0) (2 0))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik))))
  (label 18)
  (parent 17)
  (unrealized (0 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 2) (0 0)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-quote 3)
    (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik) (0 0))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))))
  (label 19)
  (parent 18)
  (unrealized (3 1))
  (comment "3 in cohort - 3 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 2) (0 0))
    ((4 2) (3 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend 3)
    (enc (hash (hash "0" n) "refuse") (hash pcrkey)) (3 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey)))))
  (label 20)
  (parent 19)
  (unrealized (4 1))
  (comment "3 in cohort - 3 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey esk-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend-enc 3 (value "refuse")
    (current-value (hash "0" n)) (pcrkey pcrkey) (esk esk-0))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 2) (0 0))
    ((4 2) (3 1)))
  (non-orig esk pcrkey esk-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend-enc 3)
    (enc (hash (hash "0" n) "refuse") (hash pcrkey)) (3 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (enc "extend" "refuse" esk-0))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey)))))
  (label 21)
  (parent 19)
  (unrealized (4 0) (4 1))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (deflistener (hash pcrkey))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 2) (0 0))
    ((4 1) (3 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc (hash (hash "0" n) "refuse") (hash pcrkey)) (3 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 22)
  (parent 19)
  (unrealized (3 1) (4 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend 3 (value n) (current-value "0") (pcrkey pcrkey))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 2) (0 0)) ((4 2) (3 1)) ((5 2) (4 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend 3)
    (enc (hash "0" n) (hash pcrkey)) (4 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey))))
    ((recv (cat "extend" n)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 23)
  (parent 20)
  (unrealized (5 0) (5 1))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey esk-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk-0))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 2) (0 0)) ((4 2) (3 1)) ((5 2) (4 1)))
  (non-orig esk pcrkey esk-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend-enc 3)
    (enc (hash "0" n) (hash pcrkey)) (4 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey))))
    ((recv (enc "extend" n esk-0)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 24)
  (parent 20)
  (unrealized (5 0) (5 1))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (deflistener (hash pcrkey))
  (precedes ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2)) ((3 2) (0 0))
    ((4 2) (3 1)) ((5 1) (4 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc (hash "0" n) (hash pcrkey)) (4 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey))))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 25)
  (parent 20)
  (unrealized (4 1) (5 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 2) (0 0)) ((4 2) (3 1)) ((5 2) (4 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (displaced 6 1 alice 1)
    (enc "extend" n esk-0) (5 0))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 26)
  (parent 24)
  (unrealized (5 1))
  (comment "2 in cohort - 2 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 2) (0 0)) ((4 2) (3 1)) ((5 2) (4 1)) ((6 1) (5 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-power-on 2)
    (enc "0" (hash pcrkey)) (5 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey)))))
  (label 27)
  (parent 26)
  (unrealized)
  (shape)
  (maps ((0 1) ((n n) (v v) (k k) (aik aik) (esk esk))))
  (origs (n (1 0)) (k (2 1)) (v (1 3))))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (deflistener (hash pcrkey))
  (precedes ((1 0) (5 0)) ((1 1) (2 0)) ((1 3) (3 0)) ((2 1) (1 2))
    ((3 2) (0 0)) ((4 2) (3 1)) ((5 2) (4 1)) ((6 1) (5 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc "0" (hash pcrkey)) (5 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 28)
  (parent 26)
  (unrealized (6 0))
  (comment "empty cohort"))

(comment "Nothing left to do")

(defprotocol envelope basic
  (defrole tpm-power-on
    (vars (pcrkey skey))
    (trace (recv "power on") (send (enc "0" (hash pcrkey))))
    (non-orig pcrkey))
  (defrole tpm-extend
    (vars (value current-value mesg) (pcrkey skey))
    (trace (recv (cat "extend" value))
      (recv (enc current-value (hash pcrkey)))
      (send (enc (hash current-value value) (hash pcrkey)))
      (send "ext ok"))
    (non-orig pcrkey))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcrkey esk skey))
    (trace (recv (enc "extend" value esk))
      (recv (enc current-value (hash pcrkey)))
      (send (enc (hash current-value value) (hash pcrkey)))
      (send "ext ok"))
    (non-orig pcrkey esk))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcrkey skey) (aik akey))
    (trace (recv (cat "quote" nonce))
      (recv (enc current-value (hash pcrkey)))
      (send (enc "quote" current-value nonce aik)))
    (non-orig pcrkey aik))
  (defrole tpm-create-key
    (vars (k aik akey) (pcrval mesg) (esk skey))
    (trace (recv (enc "create key" pcrval esk))
      (send (enc "created" k pcrval aik)))
    (non-orig esk aik (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m pcrvals mesg) (k aik akey) (pcrkey skey))
    (trace (recv (cat "decrypt" (enc m k)))
      (recv (enc "created" k pcrvals aik))
      (recv (enc pcrvals (hash pcrkey))) (send m))
    (non-orig pcrkey aik))
  (defrole alice
    (vars (n v data) (esk skey) (k aik akey))
    (trace (send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    (non-orig esk aik)
    (uniq-orig n v)))

(defskeleton envelope
  (vars (n v data) (esk skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (non-orig esk aik)
  (uniq-orig n v)
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k))))
  (label 29)
  (unrealized (0 0) (1 0) (2 2))
  (preskeleton)
  (comment "Not a skeleton"))

(defskeleton envelope
  (vars (n v data) (esk skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (precedes ((2 3) (0 0)) ((2 3) (1 0)))
  (non-orig esk aik)
  (uniq-orig n v)
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k))))
  (label 30)
  (parent 29)
  (unrealized (0 0) (2 2))
  (origs (v (2 3)) (n (2 0)))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk esk-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk-0) (k k) (aik aik))
  (precedes ((2 3) (0 0)) ((2 3) (1 0)) ((3 1) (2 2)))
  (non-orig esk esk-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-create-key 2)
    (enc "created" k (hash (hash "0" n) "obtain") aik) (2 2))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk-0))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik))))
  (label 31)
  (parent 30)
  (unrealized (0 0) (1 0) (3 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (precedes ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (1 0)) ((3 1) (2 2)))
  (non-orig esk aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (displaced 4 2 alice 2)
    (enc "create key" (hash (hash "0" n) "obtain") esk-0) (3 0))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik))))
  (label 32)
  (parent 31)
  (unrealized (0 0) (1 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (pcrvals mesg) (n v data) (esk pcrkey skey) (k aik aik-0 akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals pcrvals) (pcrkey pcrkey) (k k)
    (aik aik-0))
  (precedes ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0)) ((3 1) (2 2))
    ((4 3) (1 0)))
  (non-orig esk pcrkey aik aik-0 (invk k))
  (uniq-orig n v k)
  (operation nonce-test (added-strand tpm-decrypt 4) v (1 0) (enc v k))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k pcrvals aik-0))
      (recv (enc pcrvals (hash pcrkey))) (send v)))
  (label 33)
  (parent 32)
  (unrealized (0 0) (4 1) (4 2))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (precedes ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0)) ((3 1) (2 2))
    ((4 3) (1 0)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (displaced 5 3 tpm-create-key 2)
    (enc "created" k pcrvals aik-0) (4 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v)))
  (label 34)
  (parent 33)
  (unrealized (0 0) (4 2))
  (comment "3 in cohort - 3 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (precedes ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0)) ((3 1) (2 2))
    ((4 3) (1 0)) ((5 2) (4 2)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend 3)
    (enc (hash (hash "0" n) "obtain") (hash pcrkey)) (4 2))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey)))))
  (label 35)
  (parent 34)
  (unrealized (0 0) (5 1))
  (comment "3 in cohort - 3 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey esk-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend-enc 3 (value "obtain")
    (current-value (hash "0" n)) (pcrkey pcrkey) (esk esk-0))
  (precedes ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0)) ((3 1) (2 2))
    ((4 3) (1 0)) ((5 2) (4 2)))
  (non-orig esk pcrkey esk-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend-enc 3)
    (enc (hash (hash "0" n) "obtain") (hash pcrkey)) (4 2))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (enc "extend" "obtain" esk-0))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey)))))
  (label 36)
  (parent 34)
  (unrealized (0 0) (5 0) (5 1))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (deflistener (hash pcrkey))
  (precedes ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0)) ((3 1) (2 2))
    ((4 3) (1 0)) ((5 1) (4 2)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc (hash (hash "0" n) "obtain") (hash pcrkey)) (4 2))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 37)
  (parent 34)
  (unrealized (0 0) (5 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend 3 (value n) (current-value "0") (pcrkey pcrkey))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend 3)
    (enc (hash "0" n) (hash pcrkey)) (5 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (cat "extend" n)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 38)
  (parent 35)
  (unrealized (0 0) (6 0) (6 1))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey esk-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk-0))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1)))
  (non-orig esk pcrkey esk-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend-enc 3)
    (enc (hash "0" n) (hash pcrkey)) (5 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk-0)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 39)
  (parent 35)
  (unrealized (0 0) (6 0) (6 1))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (deflistener (hash pcrkey))
  (precedes ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0)) ((3 1) (2 2))
    ((4 3) (1 0)) ((5 2) (4 2)) ((6 1) (5 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc (hash "0" n) (hash pcrkey)) (5 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 40)
  (parent 35)
  (unrealized (0 0) (5 1) (6 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (displaced 7 2 alice 1)
    (enc "extend" n esk-0) (6 0))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 41)
  (parent 39)
  (unrealized (0 0) (6 1))
  (comment "2 in cohort - 2 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1))
    ((7 1) (6 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-power-on 2)
    (enc "0" (hash pcrkey)) (6 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey)))))
  (label 42)
  (parent 41)
  (unrealized (0 0))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (deflistener (hash pcrkey))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (0 0)) ((2 3) (4 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1))
    ((7 1) (6 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey))
    (enc "0" (hash pcrkey)) (6 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv (hash pcrkey)) (send (hash pcrkey))))
  (label 43)
  (parent 41)
  (unrealized (0 0) (7 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (4 0)) ((2 3) (8 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1))
    ((7 1) (6 1)) ((8 2) (0 0)))
  (non-orig esk pcrkey pcrkey-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-quote 3)
    (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik) (0 0))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))))
  (label 44)
  (parent 42)
  (unrealized (8 1))
  (comment "3 in cohort - 3 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey-0))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (4 0)) ((2 3) (8 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1))
    ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1)))
  (non-orig esk pcrkey pcrkey-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend 3)
    (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)) (8 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey-0)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))))
  (label 45)
  (parent 44)
  (unrealized (9 1))
  (comment "4 in cohort - 4 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 esk-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (defstrand tpm-extend-enc 3 (value "refuse")
    (current-value (hash "0" n)) (pcrkey pcrkey-0) (esk esk-0))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (4 0)) ((2 3) (8 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1))
    ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1)))
  (non-orig esk pcrkey pcrkey-0 esk-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend-enc 3)
    (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)) (8 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (enc "extend" "refuse" esk-0))
      (recv (enc (hash "0" n) (hash pcrkey-0)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))))
  (label 46)
  (parent 44)
  (unrealized (9 0) (9 1))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (deflistener (hash pcrkey-0))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (4 0)) ((2 3) (8 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1))
    ((7 1) (6 1)) ((8 2) (0 0)) ((9 1) (8 1)))
  (non-orig esk pcrkey pcrkey-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey-0))
    (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)) (8 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (hash pcrkey-0)) (send (hash pcrkey-0))))
  (label 47)
  (parent 44)
  (unrealized (8 1) (9 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey-0))
  (defstrand tpm-extend 3 (value n) (current-value "0")
    (pcrkey pcrkey-0))
  (precedes ((2 0) (6 0)) ((2 0) (10 0)) ((2 1) (3 0)) ((2 3) (4 0))
    ((2 3) (8 0)) ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2))
    ((6 2) (5 1)) ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1))
    ((10 2) (9 1)))
  (non-orig esk pcrkey pcrkey-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend 3)
    (enc (hash "0" n) (hash pcrkey-0)) (9 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey-0)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey-0))))
    ((recv (cat "extend" n)) (recv (enc "0" (hash pcrkey-0)))
      (send (enc (hash "0" n) (hash pcrkey-0)))))
  (label 48)
  (parent 45)
  (unrealized (10 0) (10 1))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (4 0)) ((2 3) (8 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1))
    ((6 2) (9 1)) ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (displaced 10 6 tpm-extend-enc 3)
    (enc (hash "0" n) (hash pcrkey-0)) (9 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey)))))
  (label 49)
  (parent 45)
  (unrealized)
  (shape)
  (maps ((0 1 2) ((n n) (v v) (k k) (aik aik) (esk esk))))
  (origs (n (2 0)) (k (3 1)) (v (2 3))))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 esk-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey-0))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey-0) (esk esk-0))
  (precedes ((2 0) (6 0)) ((2 0) (10 0)) ((2 1) (3 0)) ((2 3) (4 0))
    ((2 3) (8 0)) ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2))
    ((6 2) (5 1)) ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1))
    ((10 2) (9 1)))
  (non-orig esk pcrkey pcrkey-0 esk-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-extend-enc 3)
    (enc (hash "0" n) (hash pcrkey-0)) (9 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey-0)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey-0))))
    ((recv (enc "extend" n esk-0)) (recv (enc "0" (hash pcrkey-0)))
      (send (enc (hash "0" n) (hash pcrkey-0)))))
  (label 50)
  (parent 45)
  (unrealized (10 0) (10 1))
  (comment "1 in cohort - 1 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey-0))
  (deflistener (hash pcrkey-0))
  (precedes ((2 0) (6 0)) ((2 1) (3 0)) ((2 3) (4 0)) ((2 3) (8 0))
    ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2)) ((6 2) (5 1))
    ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1)) ((10 1) (9 1)))
  (non-orig esk pcrkey pcrkey-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey-0))
    (enc (hash "0" n) (hash pcrkey-0)) (9 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey-0)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey-0))))
    ((recv (hash pcrkey-0)) (send (hash pcrkey-0))))
  (label 51)
  (parent 45)
  (unrealized (9 1) (10 0))
  (comment "empty cohort"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey-0))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey-0) (esk esk))
  (precedes ((2 0) (6 0)) ((2 0) (10 0)) ((2 1) (3 0)) ((2 3) (4 0))
    ((2 3) (8 0)) ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2))
    ((6 2) (5 1)) ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1))
    ((10 2) (9 1)))
  (non-orig esk pcrkey pcrkey-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (displaced 11 2 alice 1)
    (enc "extend" n esk-0) (10 0))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey-0)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey-0))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey-0)))
      (send (enc (hash "0" n) (hash pcrkey-0)))))
  (label 52)
  (parent 50)
  (unrealized (10 1))
  (comment "3 in cohort - 3 not yet seen"))

(defskeleton envelope
  (vars (n v data) (esk pcrkey skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (precedes ((2 0) (6 0)) ((2 0) (10 0)) ((2 1) (3 0)) ((2 3) (4 0))
    ((2 3) (8 0)) ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2))
    ((6 2) (5 1)) ((7 1) (6 1)) ((7 1) (10 1)) ((8 2) (0 0))
    ((9 2) (8 1)) ((10 2) (9 1)))
  (non-orig esk pcrkey aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (displaced 11 7 tpm-power-on 2)
    (enc "0" (hash pcrkey-0)) (10 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey)))))
  (label 53)
  (parent 52)
  (unrealized)
  (shape)
  (maps ((0 1 2) ((n n) (v v) (k k) (aik aik) (esk esk))))
  (origs (n (2 0)) (k (3 1)) (v (2 3))))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey-0))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey-0) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey-0))
  (precedes ((2 0) (6 0)) ((2 0) (10 0)) ((2 1) (3 0)) ((2 3) (4 0))
    ((2 3) (8 0)) ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2))
    ((6 2) (5 1)) ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1))
    ((10 2) (9 1)) ((11 1) (10 1)))
  (non-orig esk pcrkey pcrkey-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-strand tpm-power-on 2)
    (enc "0" (hash pcrkey-0)) (10 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey-0)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey-0))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey-0)))
      (send (enc (hash "0" n) (hash pcrkey-0))))
    ((recv "power on") (send (enc "0" (hash pcrkey-0)))))
  (label 54)
  (parent 52)
  (unrealized)
  (shape)
  (maps ((0 1 2) ((n n) (v v) (k k) (aik aik) (esk esk))))
  (origs (n (2 0)) (k (3 1)) (v (2 3))))

(defskeleton envelope
  (vars (n v data) (esk pcrkey pcrkey-0 skey) (k aik akey))
  (deflistener (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
  (deflistener v)
  (defstrand alice 4 (n n) (v v) (esk esk) (k k) (aik aik))
  (defstrand tpm-create-key 2 (pcrval (hash (hash "0" n) "obtain"))
    (esk esk) (k k) (aik aik))
  (defstrand tpm-decrypt 4 (m v) (pcrvals (hash (hash "0" n) "obtain"))
    (pcrkey pcrkey) (k k) (aik aik))
  (defstrand tpm-extend 3 (value "obtain") (current-value (hash "0" n))
    (pcrkey pcrkey))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey) (esk esk))
  (defstrand tpm-power-on 2 (pcrkey pcrkey))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash "0" n) "refuse")) (pcrkey pcrkey-0)
    (aik aik))
  (defstrand tpm-extend 3 (value "refuse") (current-value (hash "0" n))
    (pcrkey pcrkey-0))
  (defstrand tpm-extend-enc 3 (value n) (current-value "0")
    (pcrkey pcrkey-0) (esk esk))
  (deflistener (hash pcrkey-0))
  (precedes ((2 0) (6 0)) ((2 0) (10 0)) ((2 1) (3 0)) ((2 3) (4 0))
    ((2 3) (8 0)) ((3 1) (2 2)) ((4 3) (1 0)) ((5 2) (4 2))
    ((6 2) (5 1)) ((7 1) (6 1)) ((8 2) (0 0)) ((9 2) (8 1))
    ((10 2) (9 1)) ((11 1) (10 1)))
  (non-orig esk pcrkey pcrkey-0 aik (invk k))
  (uniq-orig n v k)
  (operation encryption-test (added-listener (hash pcrkey-0))
    (enc "0" (hash pcrkey-0)) (10 1))
  (traces
    ((recv (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv v) (send v))
    ((send (enc "extend" n esk))
      (send (enc "create key" (hash (hash "0" n) "obtain") esk))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (send (enc v k)))
    ((recv (enc "create key" (hash (hash "0" n) "obtain") esk))
      (send (enc "created" k (hash (hash "0" n) "obtain") aik)))
    ((recv (cat "decrypt" (enc v k)))
      (recv (enc "created" k (hash (hash "0" n) "obtain") aik))
      (recv (enc (hash (hash "0" n) "obtain") (hash pcrkey))) (send v))
    ((recv (cat "extend" "obtain"))
      (recv (enc (hash "0" n) (hash pcrkey)))
      (send (enc (hash (hash "0" n) "obtain") (hash pcrkey))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey)))
      (send (enc (hash "0" n) (hash pcrkey))))
    ((recv "power on") (send (enc "0" (hash pcrkey))))
    ((recv (cat "quote" (enc v k)))
      (recv (enc (hash (hash "0" n) "refuse") (hash pcrkey-0)))
      (send (enc "quote" (hash (hash "0" n) "refuse") (enc v k) aik)))
    ((recv (cat "extend" "refuse"))
      (recv (enc (hash "0" n) (hash pcrkey-0)))
      (send (enc (hash (hash "0" n) "refuse") (hash pcrkey-0))))
    ((recv (enc "extend" n esk)) (recv (enc "0" (hash pcrkey-0)))
      (send (enc (hash "0" n) (hash pcrkey-0))))
    ((recv (hash pcrkey-0)) (send (hash pcrkey-0))))
  (label 55)
  (parent 52)
  (unrealized (11 0))
  (comment "empty cohort"))

(comment "Nothing left to do")
