<?xml version="1.0"?>
<!-- CPSA 4.2.3 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
 <title>Envelope Protocol, location-based version</title>
 <meta http-equiv="content-type" content="application/xhtml+xml; charset=UTF-8" />
 <style>
  svg.diagram { border-width: 1px; border-style: solid }
 </style>
</head>
<body>

<pre>(comment &quot;CPSA 4.2.3&quot;)
(comment &quot;Extracted shapes&quot;)
(herald &quot;Envelope Protocol, location-based version&quot; (check-nonces)
  (bound 30) (limit 6000))
(comment &quot;CPSA 4.2.3&quot;)
(comment &quot;All input read from sync_locn_envelope_no_auth.scm&quot;)
(comment &quot;Step count limited to 6000&quot;)
(comment &quot;Strand count bounded at 30&quot;)
(comment &quot;Nonces checked first&quot;)</pre>

<p id="top">Trees: <a href="#t0">0</a> <a href="#t388">388</a> <a href="#t590">590</a> <a href="#t1220">1220</a> <a href="#t1737">1737</a> <a href="#t2117">2117</a> <a href="#t3633">3633</a> <a href="#t4021">4021</a> <a href="#t4223">4223</a>.</p>

<p id="t0">Tree <a href="#top">0</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='379.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 379.920' font-size='12.000'>
  <text
   x='89.880' y='326.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k158&quot;, &quot;_self&quot;)'>158</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k107&quot;, &quot;_self&quot;)'>107</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k78&quot;, &quot;_self&quot;)'>78</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k72&quot;, &quot;_self&quot;)'>72</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k54&quot;, &quot;_self&quot;)'>54</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='176.040' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k0&quot;, &quot;_self&quot;)'>0</text>
  </svg></div>

<pre>(defprotocol envelope basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false)))))</pre>

<p id="k0">Item <a href="#t0">0</a>, Children: <a href="#k54">54</a> <a href="#k72">72</a> <a href="#k78">78</a> <a href="#k107">107</a> <a href="#k158">158</a>.</p>

<div>
 <svg
  class='diagram' width='179.880pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 179.880 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='139.920' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='89.940' y='39.960' style='text-anchor: middle;'>envelope 0</text>
  </svg></div>

<pre>(defskeleton envelope
  (vars (pcr-id nonce text) (v n data) (k aik akey) (tpm tpmconf chan))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig v n)
  (conf tpmconf)
  (traces ((recv v) (send v))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 0)
  (unrealized (0 0) (1 3))
  (preskeleton)
  (origs (v (1 4)) (n (1 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k54">Item <a href="#t0">54</a>, Parent: <a href="#k0">0</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 864.960 Q 342.840 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope 54 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (nonce mesg) (pcr-id nonce-0 pcr-id-0 nonce-1 pcr-id-1 text)
    (v n data) (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (3 2)) ((5 2) (2 0)) ((6 3) (0 0)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 v n pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 7 3 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (6 2))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v)))
  (label 54)
  (parent 0)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-1 (3 0)) (pt-0 (3 3)) (k (2 1)) (nonce-0 (4 0))
    (pt (4 3)) (v (1 4)) (n (1 1))))</pre>

<p id="k72">Item <a href="#t0">72</a>, Parent: <a href="#k0">0</a>.</p>

<div>
 <svg
  class='diagram' width='579.720pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 579.720 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='264.960' x2='239.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.484 487.464 343.167 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 192.900 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 339.960 Q 192.900 339.960 145.920 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 414.960 Q 236.880 377.460 333.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 186.900 264.960 233.880 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='289.860' y='39.960'
   style='text-anchor: middle;'>envelope 72 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (pcr-id nonce pcr-id-0 nonce-0 text) (v n data)
    (pt pt-0 pt-1 pval) (k aik akey) (tpmconf tpm tpm-0 chan)
    (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt)
    (k k) (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (precedes ((1 1) (5 1)) ((1 2) (2 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 3) (0 0)) ((4 3) (3 2)) ((5 0) (1 0)) ((5 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 v n pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation encryption-test (contracted (tpm-1 tpmconf))
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (2 0)
    (ch-msg tpmconf
      (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n)))))
  (label 72)
  (parent 0)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (5 0)) (pt-0 (5 3)) (nonce-0 (4 0)) (pt (4 3)) (k (2 1))
    (n (1 1)) (v (1 4))))</pre>

<p id="k78">Item <a href="#t0">78</a>, Parent: <a href="#k0">0</a>.</p>

<div>
 <svg
  class='diagram' width='779.640pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 779.640 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 739.680 414.960 Q 690.473 599.561 641.265 784.162'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot; (hash pcr-id-2 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 864.960 Q 342.840 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='389.820' y='39.960'
   style='text-anchor: middle;'>envelope 78 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (nonce mesg)
    (pcr-id nonce-0 pcr-id-0 nonce-1 pcr-id-1 pcr-id-2 nonce-2 text)
    (v n data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (3 2)) ((4 3) (7 2)) ((5 2) (2 0))
    ((6 3) (0 0)) ((7 3) (6 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 v n pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 8 4 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (7 2))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot;
          (hash pcr-id-2 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))))
  (label 78)
  (parent 0)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt (4 3)) (nonce-2 (7 0)) (pt-2 (7 3))
    (k (2 1)) (nonce-1 (3 0)) (pt-0 (3 3)) (v (1 4)) (n (1 1))))</pre>

<p id="k107">Item <a href="#t0">107</a>, Parent: <a href="#k0">0</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='264.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='339.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 339.960 Q 442.800 302.460 245.880 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.038 524.718 342.276 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 714.960 Q 192.900 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='339.840' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 192.900 414.960 145.920 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 489.960 Q 236.880 452.460 333.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 386.820 227.460 633.720 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope 107 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (pcr-id nonce pcr-id-0 nonce-0 text) (v n data)
    (pt pt-0 pt-1 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt)
    (k k) (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k-0) (aik aik-0) (tpm tpmconf))
  (precedes ((1 1) (5 1)) ((1 2) (6 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 3) (0 0)) ((4 3) (3 2)) ((5 0) (1 0)) ((5 3) (4 2))
    ((6 1) (2 0)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 v n pt pt-0 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation encryption-test (displaced 7 1 alice 3)
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (6 0))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0))))
  (label 107)
  (parent 0)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (n (1 1)) (k-0 (6 1)) (nonce (5 0)) (pt-0 (5 3))
    (nonce-0 (4 0)) (pt (4 3)) (k (2 1)) (v (1 4))))</pre>

<p id="k158">Item <a href="#t0">158</a>, Parent: <a href="#k0">0</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='189.960' x2='639.720' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='564.960' x2='539.760' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='114.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='414.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 414.960 Q 590.688 562.114 541.657 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 789.960 Q 292.860 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='539.760' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='539.760' cy='639.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='539.760' cy='564.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 342.840 377.460 245.880 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-0 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-0 nonce))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 386.820 339.960 433.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 339.840 339.960 Q 486.780 302.460 633.720 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 114.960 Q 242.880 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='339.840' cy='114.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 192.900 489.960 145.920 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 564.960 Q 336.840 527.460 533.760 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 236.880 152.460 333.840 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope 158 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (nonce mesg) (pcr-id nonce-0 pcr-id-0 pcr-id-1 nonce-1 text)
    (v n data) (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-0) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (3 1)) ((1 4) (5 0)) ((2 1) (1 3)) ((3 0) (1 0))
    ((3 3) (4 1)) ((3 3) (6 2)) ((4 2) (2 0)) ((5 3) (0 0))
    ((6 3) (5 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 v n pt-0 pt-1 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation generalization deleted (3 0))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-0 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-0 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))))
  (label 158)
  (parent 0)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (3 0)) (pt-0 (3 3)) (nonce-1 (6 0)) (pt-1 (6 3))
    (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="t388">Tree <a href="#top">388</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='304.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 304.920' font-size='12.000'>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k504&quot;, &quot;_self&quot;)'>504</text>
  <line
   x1='39.960' y1='152.460' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k466&quot;, &quot;_self&quot;)'>466</text>
  <line
   x1='39.960' y1='152.460' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k445&quot;, &quot;_self&quot;)'>445</text>
  <line
   x1='39.960' y1='152.460' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k440&quot;, &quot;_self&quot;)'>440</text>
  <line
   x1='39.960' y1='152.460' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='138.540' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k388&quot;, &quot;_self&quot;)'>388</text>
  </svg></div>

<pre>(defprotocol envelope basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false)))))</pre>

<p id="k388">Item <a href="#t388">388</a>, Children: <a href="#k440">440</a> <a href="#k445">445</a> <a href="#k466">466</a> <a href="#k504">504</a>.</p>

<div>
 <svg
  class='diagram' width='179.880pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 179.880 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='139.920' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='89.940' y='39.960'
   style='text-anchor: middle;'>envelope 388</text></svg></div>

<pre>(defskeleton envelope
  (vars (pcr-id pcr-id-0 nonce text) (n v data) (k aik akey)
    (tpm tpmconf chan))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig n v)
  (conf tpmconf)
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpm
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 388)
  (unrealized (0 0) (1 3))
  (preskeleton)
  (origs (v (1 4)) (n (1 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k440">Item <a href="#t388">440</a>, Parent: <a href="#k388">388</a>.</p>

<div>
 <svg
  class='diagram' width='579.720pt' height='679.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 579.720 679.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='264.960' x2='239.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='564.960' x2='39.960' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 392.220 450.660 344.639 486.359'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot; (hash pcr-id-1 &quot;refuse&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 192.900 527.460 45.960 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 339.960 Q 192.900 339.960 145.920 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 414.960 Q 236.880 377.460 333.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 186.900 264.960 233.880 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='564.960' r='6.000'/></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='339.840' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='289.860' y='39.960'
   style='text-anchor: middle;'>envelope 440 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik akey) (tpmconf tpm tpm-0 chan)
    (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt)
    (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (precedes ((1 1) (5 1)) ((1 2) (2 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 2) (0 0)) ((4 3) (3 1)) ((5 0) (1 0)) ((5 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 n v pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation encryption-test (contracted (tpm-1 tpmconf))
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (2 0)
    (ch-msg tpmconf
      (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot;
          (hash pcr-id-1 &quot;refuse&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n)))))
  (label 440)
  (parent 388)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (5 0)) (pt-0 (5 3)) (nonce-0 (4 0)) (pt (4 3)) (n (1 1))
    (k (2 1)) (v (1 4))))</pre>

<p id="k445">Item <a href="#t388">445</a>, Parent: <a href="#k388">388</a>.</p>

<div>
 <svg
  class='diagram' width='779.640pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 779.640 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 739.680 414.960 Q 690.648 562.114 641.617 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 789.960 Q 342.840 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='389.820' y='39.960'
   style='text-anchor: middle;'>envelope 445 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (3 2)) ((4 3) (7 2)) ((5 2) (2 0))
    ((6 2) (0 0)) ((7 3) (6 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 8 4 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (7 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 445)
  (parent 388)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt (4 3)) (nonce-2 (7 0)) (pt-2 (7 3))
    (nonce-1 (3 0)) (pt-0 (3 3)) (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="k466">Item <a href="#t388">466</a>, Parent: <a href="#k388">388</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='264.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='339.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 339.960 Q 442.800 302.460 245.880 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.484 487.464 343.167 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot; (hash pcr-id-1 &quot;refuse&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 192.900 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 192.900 414.960 145.920 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 489.960 Q 236.880 452.460 333.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 386.820 227.460 633.720 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope 466 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt)
    (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))
  (precedes ((1 1) (5 1)) ((1 2) (6 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 2) (0 0)) ((4 3) (3 1)) ((5 0) (1 0)) ((5 3) (4 2))
    ((6 1) (2 0)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 n v pt pt-0 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation encryption-test (displaced 7 1 alice 3)
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (6 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot;
          (hash pcr-id-1 &quot;refuse&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
          aik-0))))
  (label 466)
  (parent 388)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (n (1 1)) (k-0 (6 1)) (nonce (5 0)) (pt-0 (5 3))
    (nonce-0 (4 0)) (pt (4 3)) (k (2 1)) (v (1 4))))</pre>

<p id="k504">Item <a href="#t388">504</a>, Parent: <a href="#k388">388</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='189.960' x2='639.720' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='564.960' x2='539.760' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='114.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='414.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 414.960 Q 590.958 524.718 542.196 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 714.960 Q 292.860 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='539.760' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='539.760' cy='564.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 342.840 377.460 245.880 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 386.820 339.960 433.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 339.840 339.960 Q 486.780 302.460 633.720 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 114.960 Q 242.880 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='339.840' cy='114.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 192.900 489.960 145.920 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 564.960 Q 336.840 527.460 533.760 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 236.880 152.460 333.840 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-1) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope 504 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 pcr-id-2 nonce-1 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-1) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (3 1)) ((1 4) (5 0)) ((2 1) (1 3)) ((3 0) (1 0))
    ((3 3) (4 1)) ((3 3) (6 2)) ((4 2) (2 0)) ((5 2) (0 0))
    ((6 3) (5 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 n v pt-0 pt-1 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation generalization deleted (3 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 504)
  (parent 388)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (3 0)) (pt-0 (3 3)) (nonce-1 (6 0)) (pt-1 (6 3))
    (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="t590">Tree <a href="#top">590</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='379.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 379.920' font-size='12.000'>
  <text
   x='89.880' y='326.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k962&quot;, &quot;_self&quot;)'>962</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k885&quot;, &quot;_self&quot;)'>885</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k819&quot;, &quot;_self&quot;)'>819</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k780&quot;, &quot;_self&quot;)'>780</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k756&quot;, &quot;_self&quot;)'>756</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='176.040' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k590&quot;, &quot;_self&quot;)'>590</text>
  </svg></div>

<pre>(defprotocol envelope basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false)))))</pre>

<p id="k590">Item <a href="#t590">590</a>, Children: <a href="#k756">756</a> <a href="#k780">780</a> <a href="#k819">819</a> <a href="#k885">885</a> <a href="#k962">962</a>.</p>

<div>
 <svg
  class='diagram' width='279.840pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 279.840 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: red;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='139.920' y='39.960'
   style='text-anchor: middle;'>envelope 590</text></svg></div>

<pre>(defskeleton envelope
  (vars (pcr-id pcr-id-0 nonce text) (n v data) (k aik akey)
    (tpm tpmconf chan))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig n v)
  (conf tpmconf)
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpm
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 590)
  (unrealized (0 0) (1 0) (2 3))
  (preskeleton)
  (origs (v (2 4)) (n (2 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k756">Item <a href="#t590">756</a>, Parent: <a href="#k590">590</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='639.960' x2='839.640' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='639.960' x2='739.680' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='339.960' x2='639.720' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='864.960' x2='139.920' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 890.568 562.114 841.537 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-4 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 789.960 Q 442.800 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='639.960' r='6.000'/></g>
  <path
   d='M 739.680 864.960 Q 442.800 827.460 145.920 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='639.960' r='6.000'/></g>
  <path
   d='M 639.720 489.960 Q 492.780 452.460 345.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 539.760 339.960 Q 736.680 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 536.760 377.460 633.720 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 292.860 564.960 245.880 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 486.780 602.460 733.680 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 639.960 Q 536.760 602.460 833.640 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope 756 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (8 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((5 0) (2 0)) ((5 3) (4 2)) ((5 3) (9 2))
    ((6 2) (3 0)) ((7 3) (1 0)) ((8 2) (0 0)) ((9 3) (8 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 10 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (9 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((recv tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-4 (cat &quot;token&quot; nonce-2))
      (recv tpm-4
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 756)
  (parent 590)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-2 (9 0)) (pt-2 (9 3))
    (nonce-1 (4 0)) (pt-0 (4 3)) (k (3 1)) (v (2 4)) (n (2 1))))</pre>

<p id="k780">Item <a href="#t590">780</a>, Parent: <a href="#k590">590</a>.</p>

<div>
 <svg
  class='diagram' width='879.600pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 879.600 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='839.640' y1='189.960' x2='839.640' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='414.960' x2='739.680' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='114.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='189.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='414.960' x2='439.800' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='264.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='639.960' x2='139.920' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='564.960' x2='39.960' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 839.640 414.960 Q 792.060 450.660 744.479 486.359'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='839.640' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='839.640' cy='189.960' r='6.000'/></g>
  <path
   d='M 739.680 564.960 Q 392.820 527.460 45.960 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='739.680' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <path
   d='M 639.720 339.960 Q 592.740 339.960 545.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 639.720 339.960 Q 736.680 302.460 833.640 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 114.960 Q 442.800 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='639.720' cy='114.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 491.444 487.464 443.127 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 639.960 Q 292.860 602.460 145.920 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='439.800' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 292.860 339.960 245.880 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 336.840 377.460 433.800 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 414.960 Q 486.780 377.460 733.680 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 239.880 264.960 Q 286.860 264.960 333.840 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 436.800 152.460 633.720 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='714.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='564.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-2) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='739.680' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='439.800' y='39.960'
   style='text-anchor: middle;'>envelope 780 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 pcr-id-2 nonce-1 text)
    (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-2) (pcr pcr))
  (precedes ((2 1) (6 1)) ((2 2) (3 0)) ((2 4) (4 0)) ((2 4) (7 0))
    ((3 1) (2 3)) ((4 3) (1 0)) ((5 3) (4 2)) ((6 0) (2 0))
    ((6 3) (5 2)) ((6 3) (8 2)) ((7 2) (0 0)) ((8 3) (7 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 nonce-1 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 9 6 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (8 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 780)
  (parent 590)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (6 0)) (pt-0 (6 3)) (nonce-1 (8 0)) (pt-2 (8 3))
    (nonce-0 (5 0)) (pt (5 3)) (k (3 1)) (n (2 1)) (v (2 4))))</pre>

<p id="k819">Item <a href="#t590">819</a>, Parent: <a href="#k590">590</a>.</p>

<div>
 <svg
  class='diagram' width='1079.520pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 1079.520 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='1039.560' y1='189.960' x2='1039.560' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='939.600' y1='639.960' x2='939.600' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='189.960' x2='839.640' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='639.960' x2='739.680' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='339.960' x2='639.720' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='864.960' x2='139.920' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 1039.560 414.960 Q 990.528 562.114 941.497 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='414.960' r='6.000'/>
   </g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='339.960' r='6.000'/>
   </g>
  <g>
   <title>(ch-msg tpm-5 (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot; (hash pcr-id-4 &quot;refuse&quot; nonce-3)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='264.960' r='6.000'/>
   </g>
  <g><title>(ch-msg tpm-5 (cat &quot;token&quot; nonce-3))</title>
   <circle cx='1039.560' cy='189.960' r='6.000'/></g>
  <path
   d='M 939.600 789.960 Q 492.780 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='939.600' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='939.600' cy='639.960' r='6.000'/></g>
  <path
   d='M 839.640 414.960 Q 790.433 599.561 741.225 784.162'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot; (hash pcr-id-3 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='839.640' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='839.640' cy='189.960' r='6.000'/></g>
  <path
   d='M 739.680 864.960 Q 442.800 827.460 145.920 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='639.960' r='6.000'/></g>
  <path
   d='M 639.720 489.960 Q 492.780 452.460 345.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 539.760 339.960 Q 686.700 302.460 833.640 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 539.760 339.960 Q 786.660 302.460 1033.560 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 536.760 377.460 633.720 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 292.860 564.960 245.880 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 486.780 602.460 733.680 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 639.960 Q 586.740 602.460 933.600 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3) (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))</title>
   <text
    x='1039.560' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='539.760' y='39.960'
   style='text-anchor: middle;'>envelope 819 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      pcr-id-4 nonce-3 text) (n v data) (pt pt-0 pt-1 pt-2 pt-3 pval)
    (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 tpm-5 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3)
    (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (9 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((5 0) (2 0)) ((5 3) (4 2)) ((5 3) (8 2))
    ((5 3) (10 2)) ((6 2) (3 0)) ((7 3) (1 0)) ((8 3) (7 2))
    ((9 2) (0 0)) ((10 3) (9 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 nonce-3 n v pt pt-0 pt-2 pt-3 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 11 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-4 (hash &quot;0&quot; n))) (10 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot;
          (hash pcr-id-3 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-5 (cat &quot;token&quot; nonce-3))
      (recv tpm-5
        (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot;
          (hash pcr-id-4 &quot;refuse&quot; nonce-3)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 819)
  (parent 590)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-3 (10 0)) (pt-3 (10 3))
    (nonce-2 (8 0)) (pt-2 (8 3)) (k (3 1)) (nonce-1 (4 0)) (pt-0 (4 3))
    (v (2 4)) (n (2 1))))</pre>

<p id="k885">Item <a href="#t590">885</a>, Parent: <a href="#k590">590</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='489.960' x2='839.640' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='264.960' x2='739.680' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='114.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='189.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='489.960' x2='439.800' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='339.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='714.960' x2='139.920' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 891.284 487.464 842.967 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 639.960 Q 442.800 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <path
   d='M 739.680 339.960 Q 542.760 302.460 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <path
   d='M 639.720 339.960 Q 592.740 339.960 545.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 639.720 339.960 Q 786.660 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 114.960 Q 442.800 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='639.720' cy='114.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 490.998 524.718 442.236 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 714.960 Q 292.860 677.460 145.920 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='439.800' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 292.860 414.960 245.880 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 336.840 452.460 433.800 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 489.960 Q 536.760 452.460 833.640 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 264.960 Q 486.780 227.460 733.680 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 436.800 152.460 633.720 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='789.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope 885 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 pcr-id-2 nonce-1 text)
    (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((2 1) (6 1)) ((2 2) (7 0)) ((2 4) (4 0)) ((2 4) (8 0))
    ((3 1) (2 3)) ((4 3) (1 0)) ((5 3) (4 2)) ((6 0) (2 0))
    ((6 3) (5 2)) ((6 3) (9 2)) ((7 1) (3 0)) ((8 2) (0 0))
    ((9 3) (8 1)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 nonce-1 n v pt pt-0 pt-2 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 10 6 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (9 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
          aik-0)))
    ((recv tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-3 (cat &quot;token&quot; nonce-1))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 885)
  (parent 590)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (6 0)) (pt-0 (6 3)) (nonce-1 (9 0)) (pt-2 (9 3))
    (n (2 1)) (k-0 (7 1)) (nonce-0 (5 0)) (pt (5 3)) (k (3 1))
    (v (2 4))))</pre>

<p id="k962">Item <a href="#t590">962</a>, Parent: <a href="#k590">590</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='564.960' x2='839.640' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='564.960' x2='639.720' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='264.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='789.960' x2='139.920' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 890.838 524.718 842.076 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-4 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 714.960 Q 442.800 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <path
   d='M 739.680 414.960 Q 690.648 562.114 641.617 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot; (hash pcr-id-2 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 789.960 Q 392.820 752.460 145.920 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='564.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 442.800 377.460 345.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 486.780 339.960 533.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 686.700 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 342.840 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 489.960 Q 292.860 489.960 245.880 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 436.800 527.460 633.720 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 564.960 Q 536.760 527.460 833.640 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 336.840 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='864.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt-0) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope 962 (realized)</text></svg>
 </div>

<pre>(defskeleton envelope
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 pcr-id-2 nonce-1 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))
  (precedes ((2 1) (4 1)) ((2 4) (6 0)) ((2 4) (8 0)) ((3 1) (2 3))
    ((4 0) (2 0)) ((4 3) (5 1)) ((4 3) (7 2)) ((4 3) (9 2))
    ((5 2) (3 0)) ((6 3) (1 0)) ((7 3) (6 2)) ((8 2) (0 0))
    ((9 3) (8 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt-0 pt-1 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation generalization deleted (4 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot;
          (hash pcr-id-2 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-4 (cat &quot;token&quot; nonce-2))
      (recv tpm-4
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 962)
  (parent 590)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt-0 (4 3)) (nonce-2 (9 0)) (pt-2 (9 3))
    (nonce-1 (7 0)) (pt-1 (7 3)) (k (3 1)) (v (2 4)) (n (2 1))))</pre>

<p id="t1220">Tree <a href="#top">1220</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 454.920' font-size='12.000'>
  <text
   x='89.880' y='401.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1387&quot;, &quot;_self&quot;)'>1387</text>
  <line
   x1='39.960' y1='227.460' x2='89.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='326.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1329&quot;, &quot;_self&quot;)'>1329</text>
  <line
   x1='39.960' y1='227.460' x2='89.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1299&quot;, &quot;_self&quot;)'>1299</text>
  <line
   x1='39.960' y1='227.460' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1298&quot;, &quot;_self&quot;)'>1298</text>
  <line
   x1='39.960' y1='227.460' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1292&quot;, &quot;_self&quot;)'>1292</text>
  <line
   x1='39.960' y1='227.460' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1274&quot;, &quot;_self&quot;)'>1274</text>
  <line
   x1='39.960' y1='227.460' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='213.540' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k1220&quot;, &quot;_self&quot;)'>1220</text>
  </svg></div>

<pre>(defprotocol envelope-plus basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule ordered-extends
    (forall ((y z strd) (pcr locn))
      (implies
        (and (p &quot;tpm-extend-enc&quot; y 4) (p &quot;tpm-extend-enc&quot; z 4)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; y pcr)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; z pcr))
        (or (= y z) (prec y 3 z 2) (prec z 3 y 2))))))</pre>

<p id="k1220">Item <a href="#t1220">1220</a>, Children: <a href="#k1274">1274</a> <a href="#k1292">1292</a> <a href="#k1298">1298</a> <a href="#k1299">1299</a> <a href="#k1329">1329</a> <a href="#k1387">1387</a>.</p>

<div>
 <svg
  class='diagram' width='179.880pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 179.880 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='139.920' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='89.940' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1220</text></svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id nonce text) (v n data) (k aik akey) (tpm tpmconf chan))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig v n)
  (conf tpmconf)
  (traces ((recv v) (send v))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 1220)
  (unrealized (0 0) (1 3))
  (preskeleton)
  (origs (v (1 4)) (n (1 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k1274">Item <a href="#t1220">1274</a>, Parent: <a href="#k1220">1220</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 864.960 Q 342.840 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1274 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg) (pcr-id nonce-0 pcr-id-0 nonce-1 pcr-id-1 text)
    (v n data) (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (3 2)) ((5 2) (2 0)) ((6 3) (0 0)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 v n pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 7 3 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (6 2))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v)))
  (label 1274)
  (parent 1220)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-1 (3 0)) (pt-0 (3 3)) (k (2 1)) (nonce-0 (4 0))
    (pt (4 3)) (v (1 4)) (n (1 1))))</pre>

<p id="k1292">Item <a href="#t1220">1292</a>, Parent: <a href="#k1220">1220</a>.</p>

<div>
 <svg
  class='diagram' width='579.720pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 579.720 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='264.960' x2='239.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.484 487.464 343.167 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 192.900 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 339.960 Q 192.900 339.960 145.920 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 414.960 Q 236.880 377.460 333.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 186.900 264.960 233.880 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='289.860' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1292 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id nonce pcr-id-0 nonce-0 text) (v n data)
    (pt pt-0 pt-1 pval) (k aik akey) (tpmconf tpm tpm-0 chan)
    (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt)
    (k k) (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (precedes ((1 1) (5 1)) ((1 2) (2 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 3) (0 0)) ((4 3) (3 2)) ((5 0) (1 0)) ((5 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 v n pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation encryption-test (contracted (tpm-1 tpmconf))
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (2 0)
    (ch-msg tpmconf
      (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n)))))
  (label 1292)
  (parent 1220)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (5 0)) (pt-0 (5 3)) (nonce-0 (4 0)) (pt (4 3)) (k (2 1))
    (n (1 1)) (v (1 4))))</pre>

<p id="k1298">Item <a href="#t1220">1298</a>, Parent: <a href="#k1220">1220</a>.</p>

<div>
 <svg
  class='diagram' width='779.640pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 779.640 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='739.680' y1='264.960' x2='739.680' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 739.680 489.960 Q 690.648 637.114 641.617 784.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot; (hash pcr-id-2 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='739.680' cy='264.960' r='6.000'/></g>
  <path
   d='M 639.720 864.960 Q 342.840 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 339.840 414.960 Q 536.760 377.460 733.680 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='389.820' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1298 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id nonce-0 pcr-id-0 nonce-1 pcr-id-1 pcr-id-2 nonce-2 text)
    (v n data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((3 3) (7 2)) ((4 0) (1 0)) ((4 3) (3 2)) ((5 2) (2 0))
    ((6 3) (0 0)) ((7 3) (6 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 v n pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 8 4 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (7 2))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot;
          (hash pcr-id-2 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))))
  (label 1298)
  (parent 1220)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt (4 3)) (nonce-2 (7 0)) (pt-2 (7 3))
    (k (2 1)) (nonce-1 (3 0)) (pt-0 (3 3)) (v (1 4)) (n (1 1))))</pre>

<p id="k1299">Item <a href="#t1220">1299</a>, Parent: <a href="#k1220">1220</a>.</p>

<div>
 <svg
  class='diagram' width='779.640pt' height='1054.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 779.640 1054.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='714.960' x2='639.720' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='414.960' x2='539.760' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='264.960' x2='339.840' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='564.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='939.960' x2='39.960' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 739.680 414.960 Q 542.760 377.460 345.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot; (hash pcr-id-2 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 939.960 Q 342.840 902.460 45.960 939.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='939.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='789.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <path
   d='M 539.760 564.960 Q 392.820 527.460 245.880 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 489.960 Q 436.800 452.460 533.760 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 192.900 639.960 145.920 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <path
   d='M 139.920 714.960 Q 386.820 677.460 633.720 714.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='564.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='1014.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='939.960' r='6.000'/></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='389.820' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1299 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id nonce-0 pcr-id-0 nonce-1 pcr-id-1 pcr-id-2 nonce-2 text)
    (v n data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (7 2)) ((5 2) (2 0)) ((6 3) (0 0))
    ((7 3) (3 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 v n pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 8 4 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (7 2))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot;
          (hash pcr-id-2 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))))
  (label 1299)
  (parent 1220)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt (4 3)) (nonce-2 (7 0)) (pt-2 (7 3))
    (k (2 1)) (nonce-1 (3 0)) (pt-0 (3 3)) (v (1 4)) (n (1 1))))</pre>

<p id="k1329">Item <a href="#t1220">1329</a>, Parent: <a href="#k1220">1220</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='264.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='339.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 339.960 Q 442.800 302.460 245.880 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.038 524.718 342.276 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 714.960 Q 192.900 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='339.840' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 192.900 414.960 145.920 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 489.960 Q 236.880 452.460 333.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 386.820 227.460 633.720 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1329 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id nonce pcr-id-0 nonce-0 text) (v n data)
    (pt pt-0 pt-1 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt)
    (k k) (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k-0) (aik aik-0) (tpm tpmconf))
  (precedes ((1 1) (5 1)) ((1 2) (6 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 3) (0 0)) ((4 3) (3 2)) ((5 0) (1 0)) ((5 3) (4 2))
    ((6 1) (2 0)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 v n pt pt-0 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation encryption-test (displaced 7 1 alice 3)
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (6 0))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0))))
  (label 1329)
  (parent 1220)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (n (1 1)) (k-0 (6 1)) (nonce (5 0)) (pt-0 (5 3))
    (nonce-0 (4 0)) (pt (4 3)) (k (2 1)) (v (1 4))))</pre>

<p id="k1387">Item <a href="#t1220">1387</a>, Parent: <a href="#k1220">1220</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='189.960' x2='639.720' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='564.960' x2='539.760' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='114.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='414.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 414.960 Q 590.688 562.114 541.657 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 789.960 Q 292.860 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='539.760' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='539.760' cy='639.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='539.760' cy='564.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 342.840 377.460 245.880 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-0 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-0 nonce))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 386.820 339.960 433.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 339.840 339.960 Q 486.780 302.460 633.720 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 114.960 Q 242.880 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='339.840' cy='114.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 192.900 489.960 145.920 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 564.960 Q 336.840 527.460 533.760 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 236.880 152.460 333.840 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1387 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg) (pcr-id nonce-0 pcr-id-0 pcr-id-1 nonce-1 text)
    (v n data) (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-0) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (3 1)) ((1 4) (5 0)) ((2 1) (1 3)) ((3 0) (1 0))
    ((3 3) (4 1)) ((3 3) (6 2)) ((4 2) (2 0)) ((5 3) (0 0))
    ((6 3) (5 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 v n pt-0 pt-1 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation generalization deleted (3 0))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-0 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-0 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))))
  (label 1387)
  (parent 1220)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (3 0)) (pt-0 (3 3)) (nonce-1 (6 0)) (pt-1 (6 3))
    (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="t1737">Tree <a href="#top">1737</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='379.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 379.920' font-size='12.000'>
  <text
   x='89.880' y='326.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1861&quot;, &quot;_self&quot;)'>1861</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1817&quot;, &quot;_self&quot;)'>1817</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1795&quot;, &quot;_self&quot;)'>1795</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1794&quot;, &quot;_self&quot;)'>1794</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k1789&quot;, &quot;_self&quot;)'>1789</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='176.040' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k1737&quot;, &quot;_self&quot;)'>1737</text>
  </svg></div>

<pre>(defprotocol envelope-plus basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule ordered-extends
    (forall ((y z strd) (pcr locn))
      (implies
        (and (p &quot;tpm-extend-enc&quot; y 4) (p &quot;tpm-extend-enc&quot; z 4)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; y pcr)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; z pcr))
        (or (= y z) (prec y 3 z 2) (prec z 3 y 2))))))</pre>

<p id="k1737">Item <a href="#t1737">1737</a>, Children: <a href="#k1789">1789</a> <a href="#k1794">1794</a> <a href="#k1795">1795</a> <a href="#k1817">1817</a> <a href="#k1861">1861</a>.</p>

<div>
 <svg
  class='diagram' width='179.880pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 179.880 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='139.920' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='89.940' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1737</text></svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id pcr-id-0 nonce text) (n v data) (k aik akey)
    (tpm tpmconf chan))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig n v)
  (conf tpmconf)
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpm
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 1737)
  (unrealized (0 0) (1 3))
  (preskeleton)
  (origs (v (1 4)) (n (1 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k1789">Item <a href="#t1737">1789</a>, Parent: <a href="#k1737">1737</a>.</p>

<div>
 <svg
  class='diagram' width='579.720pt' height='679.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 579.720 679.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='264.960' x2='239.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='564.960' x2='39.960' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 392.220 450.660 344.639 486.359'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot; (hash pcr-id-1 &quot;refuse&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 192.900 527.460 45.960 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 339.960 Q 192.900 339.960 145.920 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 414.960 Q 236.880 377.460 333.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 186.900 264.960 233.880 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='564.960' r='6.000'/></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='339.840' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='289.860' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1789 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik akey) (tpmconf tpm tpm-0 chan)
    (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt)
    (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (precedes ((1 1) (5 1)) ((1 2) (2 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 2) (0 0)) ((4 3) (3 1)) ((5 0) (1 0)) ((5 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 n v pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation encryption-test (contracted (tpm-1 tpmconf))
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (2 0)
    (ch-msg tpmconf
      (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot;
          (hash pcr-id-1 &quot;refuse&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n)))))
  (label 1789)
  (parent 1737)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (5 0)) (pt-0 (5 3)) (nonce-0 (4 0)) (pt (4 3)) (n (1 1))
    (k (2 1)) (v (1 4))))</pre>

<p id="k1794">Item <a href="#t1737">1794</a>, Parent: <a href="#k1737">1737</a>.</p>

<div>
 <svg
  class='diagram' width='779.640pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 779.640 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='739.680' y1='264.960' x2='739.680' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 739.680 489.960 Q 690.918 599.718 642.156 709.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='739.680' cy='264.960' r='6.000'/></g>
  <path
   d='M 639.720 789.960 Q 342.840 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 339.840 414.960 Q 536.760 377.460 733.680 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='389.820' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1794 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((3 3) (7 2)) ((4 0) (1 0)) ((4 3) (3 2)) ((5 2) (2 0))
    ((6 2) (0 0)) ((7 3) (6 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 8 4 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (7 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 1794)
  (parent 1737)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt (4 3)) (nonce-2 (7 0)) (pt-2 (7 3))
    (nonce-1 (3 0)) (pt-0 (3 3)) (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="k1795">Item <a href="#t1737">1795</a>, Parent: <a href="#k1737">1737</a>.</p>

<div>
 <svg
  class='diagram' width='779.640pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 779.640 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='714.960' x2='639.720' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='414.960' x2='539.760' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='264.960' x2='339.840' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='564.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 739.680 414.960 Q 542.760 377.460 345.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 864.960 Q 342.840 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='639.720' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <path
   d='M 539.760 564.960 Q 392.820 527.460 245.880 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 489.960 Q 436.800 452.460 533.760 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 192.900 639.960 145.920 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <path
   d='M 139.920 714.960 Q 386.820 677.460 633.720 714.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='564.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='389.820' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1795 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (7 2)) ((5 2) (2 0)) ((6 2) (0 0))
    ((7 3) (3 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 8 4 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (7 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 1795)
  (parent 1737)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt (4 3)) (nonce-2 (7 0)) (pt-2 (7 3))
    (nonce-1 (3 0)) (pt-0 (3 3)) (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="k1817">Item <a href="#t1737">1817</a>, Parent: <a href="#k1737">1737</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='264.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='339.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 339.960 Q 442.800 302.460 245.880 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.484 487.464 343.167 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot; (hash pcr-id-1 &quot;refuse&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 192.900 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 192.900 414.960 145.920 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 489.960 Q 236.880 452.460 333.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 386.820 227.460 633.720 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1817 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt)
    (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))
  (precedes ((1 1) (5 1)) ((1 2) (6 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 2) (0 0)) ((4 3) (3 1)) ((5 0) (1 0)) ((5 3) (4 2))
    ((6 1) (2 0)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 n v pt pt-0 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation encryption-test (displaced 7 1 alice 3)
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (6 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot;
          (hash pcr-id-1 &quot;refuse&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
          aik-0))))
  (label 1817)
  (parent 1737)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (n (1 1)) (k-0 (6 1)) (nonce (5 0)) (pt-0 (5 3))
    (nonce-0 (4 0)) (pt (4 3)) (k (2 1)) (v (1 4))))</pre>

<p id="k1861">Item <a href="#t1737">1861</a>, Parent: <a href="#k1737">1737</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='189.960' x2='639.720' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='564.960' x2='539.760' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='114.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='414.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 414.960 Q 590.958 524.718 542.196 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 714.960 Q 292.860 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='539.760' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='539.760' cy='564.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 342.840 377.460 245.880 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 386.820 339.960 433.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 339.840 339.960 Q 486.780 302.460 633.720 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 114.960 Q 242.880 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='339.840' cy='114.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 192.900 489.960 145.920 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 564.960 Q 336.840 527.460 533.760 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 236.880 152.460 333.840 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-1) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus 1861 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 pcr-id-2 nonce-1 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-1) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (3 1)) ((1 4) (5 0)) ((2 1) (1 3)) ((3 0) (1 0))
    ((3 3) (4 1)) ((3 3) (6 2)) ((4 2) (2 0)) ((5 2) (0 0))
    ((6 3) (5 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 n v pt-0 pt-1 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation generalization deleted (3 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 1861)
  (parent 1737)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (3 0)) (pt-0 (3 3)) (nonce-1 (6 0)) (pt-1 (6 3))
    (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="t2117">Tree <a href="#top">2117</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='1054.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 1054.920' font-size='12.000'>
  <text
   x='89.880' y='1001.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2619&quot;, &quot;_self&quot;)'>2619</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='926.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2618&quot;, &quot;_self&quot;)'>2618</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='851.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2480&quot;, &quot;_self&quot;)'>2480</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='776.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2479&quot;, &quot;_self&quot;)'>2479</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='701.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2382&quot;, &quot;_self&quot;)'>2382</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='626.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2381&quot;, &quot;_self&quot;)'>2381</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='551.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2380&quot;, &quot;_self&quot;)'>2380</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='476.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2378&quot;, &quot;_self&quot;)'>2378</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='401.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2377&quot;, &quot;_self&quot;)'>2377</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='326.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2376&quot;, &quot;_self&quot;)'>2376</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2324&quot;, &quot;_self&quot;)'>2324</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2323&quot;, &quot;_self&quot;)'>2323</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2294&quot;, &quot;_self&quot;)'>2294</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k2293&quot;, &quot;_self&quot;)'>2293</text>
  <line
   x1='39.960' y1='527.460' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='513.540' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k2117&quot;, &quot;_self&quot;)'>2117</text>
  </svg></div>

<pre>(defprotocol envelope-plus basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule ordered-extends
    (forall ((y z strd) (pcr locn))
      (implies
        (and (p &quot;tpm-extend-enc&quot; y 4) (p &quot;tpm-extend-enc&quot; z 4)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; y pcr)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; z pcr))
        (or (= y z) (prec y 3 z 2) (prec z 3 y 2))))))</pre>

<p id="k2117">Item <a href="#t2117">2117</a>, Children: <a href="#k2293">2293</a> <a href="#k2294">2294</a> <a href="#k2323">2323</a> <a href="#k2324">2324</a> <a href="#k2376">2376</a> <a href="#k2377">2377</a> <a href="#k2378">2378</a> <a href="#k2380">2380</a> <a href="#k2381">2381</a> <a href="#k2382">2382</a> <a href="#k2479">2479</a> <a href="#k2480">2480</a> <a href="#k2618">2618</a> <a href="#k2619">2619</a>.</p>

<div>
 <svg
  class='diagram' width='279.840pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 279.840 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: red;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='139.920' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2117</text></svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id pcr-id-0 nonce text) (n v data) (k aik akey)
    (tpm tpmconf chan))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig n v)
  (conf tpmconf)
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpm
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 2117)
  (unrealized (0 0) (1 0) (2 3))
  (preskeleton)
  (origs (v (2 4)) (n (2 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k2293">Item <a href="#t2117">2293</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='264.960' x2='939.600' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='639.960' x2='839.640' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='639.960' x2='739.680' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='339.960' x2='639.720' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='864.960' x2='139.920' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 489.960 Q 890.838 599.718 842.076 709.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-4 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='939.600' cy='264.960' r='6.000'/></g>
  <path
   d='M 839.640 789.960 Q 442.800 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='639.960' r='6.000'/></g>
  <path
   d='M 739.680 864.960 Q 442.800 827.460 145.920 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='639.960' r='6.000'/></g>
  <path
   d='M 639.720 489.960 Q 492.780 452.460 345.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 536.760 377.460 633.720 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 414.960 Q 686.700 377.460 933.600 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 292.860 564.960 245.880 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 486.780 602.460 733.680 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 639.960 Q 536.760 602.460 833.640 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2293 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (8 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((4 3) (9 2)) ((5 0) (2 0)) ((5 3) (4 2))
    ((6 2) (3 0)) ((7 3) (1 0)) ((8 2) (0 0)) ((9 3) (8 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 10 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (9 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((recv tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-4 (cat &quot;token&quot; nonce-2))
      (recv tpm-4
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2293)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-2 (9 0)) (pt-2 (9 3))
    (nonce-1 (4 0)) (pt-0 (4 3)) (k (3 1)) (v (2 4)) (n (2 1))))</pre>

<p id="k2294">Item <a href="#t2117">2294</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='1054.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 1054.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='714.960' x2='839.640' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='714.960' x2='739.680' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='414.960' x2='639.720' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='564.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='939.960' x2='139.920' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 692.700 377.460 445.800 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-4 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 864.960 Q 442.800 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='714.960' r='6.000'/></g>
  <path
   d='M 739.680 939.960 Q 442.800 902.460 145.920 939.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='939.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <path
   d='M 639.720 564.960 Q 492.780 527.460 345.840 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 736.680 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 489.960 Q 536.760 452.460 633.720 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 292.860 639.960 245.880 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <path
   d='M 239.880 714.960 Q 486.780 677.460 733.680 714.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 714.960 Q 536.760 677.460 833.640 714.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='1014.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2294 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (8 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((5 0) (2 0)) ((5 3) (9 2)) ((6 2) (3 0))
    ((7 3) (1 0)) ((8 2) (0 0)) ((9 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 10 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (9 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((recv tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-4 (cat &quot;token&quot; nonce-2))
      (recv tpm-4
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2294)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-2 (9 0)) (pt-2 (9 3))
    (nonce-1 (4 0)) (pt-0 (4 3)) (k (3 1)) (v (2 4)) (n (2 1))))</pre>

<p id="k2323">Item <a href="#t2117">2323</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='879.600pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 879.600 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='839.640' y1='264.960' x2='839.640' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='414.960' x2='739.680' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='114.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='189.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='414.960' x2='439.800' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='264.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='639.960' x2='139.920' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='564.960' x2='39.960' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 839.640 489.960 Q 792.660 489.960 745.680 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='839.640' cy='264.960' r='6.000'/></g>
  <path
   d='M 739.680 564.960 Q 392.820 527.460 45.960 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='739.680' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <path
   d='M 639.720 339.960 Q 592.740 339.960 545.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 114.960 Q 442.800 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='639.720' cy='114.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 491.444 487.464 443.127 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 539.760 414.960 Q 686.700 377.460 833.640 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 639.960 Q 292.860 602.460 145.920 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='439.800' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 292.860 339.960 245.880 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 336.840 377.460 433.800 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 414.960 Q 486.780 377.460 733.680 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 239.880 264.960 Q 286.860 264.960 333.840 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 436.800 152.460 633.720 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='714.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='564.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-2) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='739.680' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='439.800' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2323 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 pcr-id-2 nonce-1 text)
    (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-2) (pcr pcr))
  (precedes ((2 1) (6 1)) ((2 2) (3 0)) ((2 4) (4 0)) ((2 4) (7 0))
    ((3 1) (2 3)) ((4 3) (1 0)) ((5 3) (4 2)) ((5 3) (8 2))
    ((6 0) (2 0)) ((6 3) (5 2)) ((7 2) (0 0)) ((8 3) (7 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 nonce-1 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 9 6 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (8 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2323)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (6 0)) (pt-0 (6 3)) (nonce-1 (8 0)) (pt-2 (8 3))
    (nonce-0 (5 0)) (pt (5 3)) (k (3 1)) (n (2 1)) (v (2 4))))</pre>

<p id="k2324">Item <a href="#t2117">2324</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='879.600pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 879.600 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='839.640' y1='189.960' x2='839.640' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='414.960' x2='739.680' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='114.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='264.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='414.960' x2='439.800' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='264.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='639.960' x2='139.920' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='564.960' x2='39.960' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 839.640 414.960 Q 692.700 377.460 545.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 839.640 414.960 Q 792.060 450.660 744.479 486.359'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='839.640' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='839.640' cy='189.960' r='6.000'/></g>
  <path
   d='M 739.680 564.960 Q 392.820 527.460 45.960 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='739.680' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <path
   d='M 639.720 339.960 Q 736.680 302.460 833.640 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 114.960 Q 442.800 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='639.720' cy='114.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 492.180 525.660 444.599 561.359'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='264.960' r='6.000'/></g>
  <path
   d='M 439.800 639.960 Q 292.860 602.460 145.920 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='439.800' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 292.860 339.960 245.880 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 336.840 377.460 433.800 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 414.960 Q 486.780 377.460 733.680 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 239.880 264.960 Q 286.860 264.960 333.840 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 436.800 152.460 633.720 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='714.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='564.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-2) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='739.680' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='439.800' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2324 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 pcr-id-2 nonce-1 text)
    (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-2) (pcr pcr))
  (precedes ((2 1) (6 1)) ((2 2) (3 0)) ((2 4) (4 0)) ((2 4) (7 0))
    ((3 1) (2 3)) ((4 3) (1 0)) ((5 3) (4 2)) ((6 0) (2 0))
    ((6 3) (8 2)) ((7 2) (0 0)) ((8 3) (5 2)) ((8 3) (7 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 nonce-1 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 9 6 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (8 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2324)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (6 0)) (pt-0 (6 3)) (nonce-1 (8 0)) (pt-2 (8 3))
    (nonce-0 (5 0)) (pt (5 3)) (k (3 1)) (n (2 1)) (v (2 4))))</pre>

<p id="k2376">Item <a href="#t2117">2376</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='1079.520pt' height='1054.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 1079.520 1054.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='1039.560' y1='189.960' x2='1039.560' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='939.600' y1='714.960' x2='939.600' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='339.960' x2='839.640' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='714.960' x2='739.680' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='414.960' x2='639.720' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='564.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='939.960' x2='139.920' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 1039.560 414.960 Q 742.680 377.460 445.800 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='414.960' r='6.000'/>
   </g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='339.960' r='6.000'/>
   </g>
  <g>
   <title>(ch-msg tpm-5 (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot; (hash pcr-id-4 &quot;refuse&quot; nonce-3)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='264.960' r='6.000'/>
   </g>
  <g><title>(ch-msg tpm-5 (cat &quot;token&quot; nonce-3))</title>
   <circle cx='1039.560' cy='189.960' r='6.000'/></g>
  <path
   d='M 939.600 864.960 Q 492.780 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='939.600' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='939.600' cy='714.960' r='6.000'/></g>
  <path
   d='M 839.640 564.960 Q 790.608 712.114 741.577 859.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot; (hash pcr-id-3 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='839.640' cy='339.960' r='6.000'/></g>
  <path
   d='M 739.680 939.960 Q 442.800 902.460 145.920 939.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='939.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <path
   d='M 639.720 564.960 Q 492.780 527.460 345.840 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 786.660 302.460 1033.560 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 489.960 Q 536.760 452.460 633.720 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 489.960 Q 636.720 452.460 833.640 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 292.860 639.960 245.880 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <path
   d='M 239.880 714.960 Q 486.780 677.460 733.680 714.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 714.960 Q 586.740 677.460 933.600 714.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='1014.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3) (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))</title>
   <text
    x='1039.560' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='539.760' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2376 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      pcr-id-4 nonce-3 text) (n v data) (pt pt-0 pt-1 pt-2 pt-3 pval)
    (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 tpm-5 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3)
    (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (9 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((4 3) (8 2)) ((5 0) (2 0)) ((5 3) (10 2))
    ((6 2) (3 0)) ((7 3) (1 0)) ((8 3) (7 2)) ((9 2) (0 0))
    ((10 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 nonce-3 n v pt pt-0 pt-2 pt-3 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 11 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-4 (hash &quot;0&quot; n))) (10 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot;
          (hash pcr-id-3 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-5 (cat &quot;token&quot; nonce-3))
      (recv tpm-5
        (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot;
          (hash pcr-id-4 &quot;refuse&quot; nonce-3)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2376)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-3 (10 0)) (pt-3 (10 3))
    (nonce-2 (8 0)) (pt-2 (8 3)) (k (3 1)) (nonce-1 (4 0)) (pt-0 (4 3))
    (v (2 4)) (n (2 1))))</pre>

<p id="k2377">Item <a href="#t2117">2377</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='1079.520pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 1079.520 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='1039.560' y1='339.960' x2='1039.560' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='939.600' y1='639.960' x2='939.600' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='264.960' x2='839.640' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='639.960' x2='739.680' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='339.960' x2='639.720' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='864.960' x2='139.920' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 1039.560 564.960 Q 991.244 637.464 942.927 709.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='564.960' r='6.000'/>
   </g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='489.960' r='6.000'/>
   </g>
  <g>
   <title>(ch-msg tpm-5 (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot; (hash pcr-id-4 &quot;refuse&quot; nonce-3)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='414.960' r='6.000'/>
   </g>
  <g><title>(ch-msg tpm-5 (cat &quot;token&quot; nonce-3))</title>
   <circle cx='1039.560' cy='339.960' r='6.000'/></g>
  <path
   d='M 939.600 789.960 Q 492.780 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='939.600' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='939.600' cy='639.960' r='6.000'/></g>
  <path
   d='M 839.640 489.960 Q 790.608 637.114 741.577 784.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 839.640 489.960 Q 936.600 452.460 1033.560 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot; (hash pcr-id-3 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='839.640' cy='264.960' r='6.000'/></g>
  <path
   d='M 739.680 864.960 Q 442.800 827.460 145.920 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='639.960' r='6.000'/></g>
  <path
   d='M 639.720 489.960 Q 492.780 452.460 345.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 536.760 377.460 633.720 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 414.960 Q 636.720 377.460 833.640 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 292.860 564.960 245.880 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 486.780 602.460 733.680 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 639.960 Q 586.740 602.460 933.600 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3) (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))</title>
   <text
    x='1039.560' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='539.760' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2377 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      pcr-id-4 nonce-3 text) (n v data) (pt pt-0 pt-1 pt-2 pt-3 pval)
    (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 tpm-5 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3)
    (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (9 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((4 3) (8 2)) ((5 0) (2 0)) ((5 3) (4 2))
    ((6 2) (3 0)) ((7 3) (1 0)) ((8 3) (7 2)) ((8 3) (10 2))
    ((9 2) (0 0)) ((10 3) (9 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 nonce-3 n v pt pt-0 pt-2 pt-3 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 11 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-4 (hash &quot;0&quot; n))) (10 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot;
          (hash pcr-id-3 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-5 (cat &quot;token&quot; nonce-3))
      (recv tpm-5
        (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot;
          (hash pcr-id-4 &quot;refuse&quot; nonce-3)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2377)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-3 (10 0)) (pt-3 (10 3))
    (nonce-2 (8 0)) (pt-2 (8 3)) (k (3 1)) (nonce-1 (4 0)) (pt-0 (4 3))
    (v (2 4)) (n (2 1))))</pre>

<p id="k2378">Item <a href="#t2117">2378</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='1079.520pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 1079.520 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='1039.560' y1='264.960' x2='1039.560' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='939.600' y1='639.960' x2='939.600' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='339.960' x2='839.640' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='639.960' x2='739.680' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='339.960' x2='639.720' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='864.960' x2='139.920' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 1039.560 489.960 Q 942.600 452.460 845.640 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 1039.560 489.960 Q 990.798 599.718 942.036 709.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='489.960' r='6.000'/>
   </g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='414.960' r='6.000'/>
   </g>
  <g>
   <title>(ch-msg tpm-5 (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot; (hash pcr-id-4 &quot;refuse&quot; nonce-3)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='339.960' r='6.000'/>
   </g>
  <g><title>(ch-msg tpm-5 (cat &quot;token&quot; nonce-3))</title>
   <circle cx='1039.560' cy='264.960' r='6.000'/></g>
  <path
   d='M 939.600 789.960 Q 492.780 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='939.600' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='939.600' cy='639.960' r='6.000'/></g>
  <path
   d='M 839.640 564.960 Q 790.878 674.718 742.116 784.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot; (hash pcr-id-3 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='839.640' cy='339.960' r='6.000'/></g>
  <path
   d='M 739.680 864.960 Q 442.800 827.460 145.920 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='639.960' r='6.000'/></g>
  <path
   d='M 639.720 489.960 Q 492.780 452.460 345.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 536.760 377.460 633.720 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 414.960 Q 736.680 377.460 1033.560 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 292.860 564.960 245.880 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 486.780 602.460 733.680 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 639.960 Q 586.740 602.460 933.600 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3) (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))</title>
   <text
    x='1039.560' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='539.760' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2378 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      pcr-id-4 nonce-3 text) (n v data) (pt pt-0 pt-1 pt-2 pt-3 pval)
    (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 tpm-5 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3)
    (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (9 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((4 3) (10 2)) ((5 0) (2 0)) ((5 3) (4 2))
    ((6 2) (3 0)) ((7 3) (1 0)) ((8 3) (7 2)) ((9 2) (0 0))
    ((10 3) (8 2)) ((10 3) (9 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 nonce-3 n v pt pt-0 pt-2 pt-3 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends ordered-extends)
  (operation channel-test (displaced 11 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-4 (hash &quot;0&quot; n))) (10 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot;
          (hash pcr-id-3 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-5 (cat &quot;token&quot; nonce-3))
      (recv tpm-5
        (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot;
          (hash pcr-id-4 &quot;refuse&quot; nonce-3)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2378)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-3 (10 0)) (pt-3 (10 3))
    (nonce-2 (8 0)) (pt-2 (8 3)) (k (3 1)) (nonce-1 (4 0)) (pt-0 (4 3))
    (v (2 4)) (n (2 1))))</pre>

<p id="k2380">Item <a href="#t2117">2380</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='1079.520pt' height='1054.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 1079.520 1054.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='1039.560' y1='339.960' x2='1039.560' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='939.600' y1='714.960' x2='939.600' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='189.960' x2='839.640' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='714.960' x2='739.680' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='414.960' x2='639.720' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='564.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='939.960' x2='139.920' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 1039.560 564.960 Q 990.798 674.718 942.036 784.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='564.960' r='6.000'/>
   </g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='489.960' r='6.000'/>
   </g>
  <g>
   <title>(ch-msg tpm-5 (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot; (hash pcr-id-4 &quot;refuse&quot; nonce-3)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='414.960' r='6.000'/>
   </g>
  <g><title>(ch-msg tpm-5 (cat &quot;token&quot; nonce-3))</title>
   <circle cx='1039.560' cy='339.960' r='6.000'/></g>
  <path
   d='M 939.600 864.960 Q 492.780 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='939.600' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='939.600' cy='714.960' r='6.000'/></g>
  <path
   d='M 839.640 414.960 Q 642.720 377.460 445.800 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot; (hash pcr-id-3 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='839.640' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='839.640' cy='189.960' r='6.000'/></g>
  <path
   d='M 739.680 939.960 Q 442.800 902.460 145.920 939.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='939.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <path
   d='M 639.720 564.960 Q 492.780 527.460 345.840 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 686.700 302.460 833.640 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 489.960 Q 536.760 452.460 633.720 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 489.960 Q 736.680 452.460 1033.560 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 292.860 639.960 245.880 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <path
   d='M 239.880 714.960 Q 486.780 677.460 733.680 714.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 714.960 Q 586.740 677.460 933.600 714.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='1014.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3) (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))</title>
   <text
    x='1039.560' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='539.760' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2380 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      pcr-id-4 nonce-3 text) (n v data) (pt pt-0 pt-1 pt-2 pt-3 pval)
    (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 tpm-5 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3)
    (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (9 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((4 3) (10 2)) ((5 0) (2 0)) ((5 3) (8 2))
    ((6 2) (3 0)) ((7 3) (1 0)) ((8 3) (4 2)) ((9 2) (0 0))
    ((10 3) (9 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 nonce-3 n v pt pt-0 pt-2 pt-3 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 11 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-4 (hash &quot;0&quot; n))) (10 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot;
          (hash pcr-id-3 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-5 (cat &quot;token&quot; nonce-3))
      (recv tpm-5
        (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot;
          (hash pcr-id-4 &quot;refuse&quot; nonce-3)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2380)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-3 (10 0)) (pt-3 (10 3))
    (nonce-2 (8 0)) (pt-2 (8 3)) (k (3 1)) (nonce-1 (4 0)) (pt-0 (4 3))
    (v (2 4)) (n (2 1))))</pre>

<p id="k2381">Item <a href="#t2117">2381</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='1079.520pt' height='1129.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 1079.520 1129.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='1039.560' y1='189.960' x2='1039.560' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='939.600' y1='789.960' x2='939.600' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='264.960' x2='839.640' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='789.960' x2='739.680' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='489.960' x2='639.720' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='339.960' x2='439.800' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='639.960' x2='339.840' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='1014.960' x2='139.920' y2='1089.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='939.960' x2='39.960' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 1039.560 414.960 Q 942.600 377.460 845.640 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='414.960' r='6.000'/>
   </g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='339.960' r='6.000'/>
   </g>
  <g>
   <title>(ch-msg tpm-5 (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot; (hash pcr-id-4 &quot;refuse&quot; nonce-3)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='264.960' r='6.000'/>
   </g>
  <g><title>(ch-msg tpm-5 (cat &quot;token&quot; nonce-3))</title>
   <circle cx='1039.560' cy='189.960' r='6.000'/></g>
  <path
   d='M 939.600 939.960 Q 492.780 902.460 45.960 939.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='939.600' cy='939.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='939.600' cy='789.960' r='6.000'/></g>
  <path
   d='M 839.640 489.960 Q 642.720 452.460 445.800 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot; (hash pcr-id-3 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='839.640' cy='264.960' r='6.000'/></g>
  <path
   d='M 739.680 1014.960 Q 442.800 977.460 145.920 1014.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='1014.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='864.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <path
   d='M 639.720 639.960 Q 492.780 602.460 345.840 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='489.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 786.660 302.460 1033.560 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 564.960 Q 536.760 527.460 633.720 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='339.960' r='6.000'/></g>
  <path
   d='M 339.840 714.960 Q 292.860 714.960 245.880 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='639.960' r='6.000'/></g>
  <path
   d='M 239.880 789.960 Q 486.780 752.460 733.680 789.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 789.960 Q 586.740 752.460 933.600 789.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='1089.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='1014.960' r='6.000'/>
   </g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='1014.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='939.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3) (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))</title>
   <text
    x='1039.560' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='539.760' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2381 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      pcr-id-4 nonce-3 text) (n v data) (pt pt-0 pt-1 pt-2 pt-3 pval)
    (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 tpm-5 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3)
    (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (9 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((5 0) (2 0)) ((5 3) (10 2)) ((6 2) (3 0))
    ((7 3) (1 0)) ((8 3) (4 2)) ((9 2) (0 0)) ((10 3) (8 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 nonce-3 n v pt pt-0 pt-2 pt-3 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 11 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-4 (hash &quot;0&quot; n))) (10 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot;
          (hash pcr-id-3 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-5 (cat &quot;token&quot; nonce-3))
      (recv tpm-5
        (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot;
          (hash pcr-id-4 &quot;refuse&quot; nonce-3)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2381)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-3 (10 0)) (pt-3 (10 3))
    (nonce-2 (8 0)) (pt-2 (8 3)) (k (3 1)) (nonce-1 (4 0)) (pt-0 (4 3))
    (v (2 4)) (n (2 1))))</pre>

<p id="k2382">Item <a href="#t2117">2382</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='1079.520pt' height='1129.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 1079.520 1129.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='1039.560' y1='264.960' x2='1039.560' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='939.600' y1='789.960' x2='939.600' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='189.960' x2='839.640' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='789.960' x2='739.680' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='489.960' x2='639.720' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='339.960' x2='439.800' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='639.960' x2='339.840' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='1014.960' x2='139.920' y2='1089.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='939.960' x2='39.960' y2='1014.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 1039.560 489.960 Q 742.680 452.460 445.800 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='489.960' r='6.000'/>
   </g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='414.960' r='6.000'/>
   </g>
  <g>
   <title>(ch-msg tpm-5 (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot; (hash pcr-id-4 &quot;refuse&quot; nonce-3)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='339.960' r='6.000'/>
   </g>
  <g><title>(ch-msg tpm-5 (cat &quot;token&quot; nonce-3))</title>
   <circle cx='1039.560' cy='264.960' r='6.000'/></g>
  <path
   d='M 939.600 939.960 Q 492.780 902.460 45.960 939.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='939.600' cy='939.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='939.600' cy='789.960' r='6.000'/></g>
  <path
   d='M 839.640 414.960 Q 936.600 377.460 1033.560 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot; (hash pcr-id-3 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='839.640' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='839.640' cy='189.960' r='6.000'/></g>
  <path
   d='M 739.680 1014.960 Q 442.800 977.460 145.920 1014.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='1014.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='939.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='864.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <path
   d='M 639.720 639.960 Q 492.780 602.460 345.840 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='489.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 686.700 302.460 833.640 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 564.960 Q 536.760 527.460 633.720 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='339.960' r='6.000'/></g>
  <path
   d='M 339.840 714.960 Q 292.860 714.960 245.880 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='639.960' r='6.000'/></g>
  <path
   d='M 239.880 789.960 Q 486.780 752.460 733.680 789.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 789.960 Q 586.740 752.460 933.600 789.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='1089.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='1014.960' r='6.000'/>
   </g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='1014.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='939.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3) (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))</title>
   <text
    x='1039.560' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='539.760' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2382 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      pcr-id-4 nonce-3 text) (n v data) (pt pt-0 pt-1 pt-2 pt-3 pval)
    (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 tpm-5 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3)
    (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (9 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((5 0) (2 0)) ((5 3) (8 2)) ((6 2) (3 0))
    ((7 3) (1 0)) ((8 3) (10 2)) ((9 2) (0 0)) ((10 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 nonce-3 n v pt pt-0 pt-2 pt-3 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends ordered-extends)
  (operation channel-test (displaced 11 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-4 (hash &quot;0&quot; n))) (10 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot;
          (hash pcr-id-3 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-5 (cat &quot;token&quot; nonce-3))
      (recv tpm-5
        (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot;
          (hash pcr-id-4 &quot;refuse&quot; nonce-3)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2382)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-3 (10 0)) (pt-3 (10 3))
    (nonce-2 (8 0)) (pt-2 (8 3)) (k (3 1)) (nonce-1 (4 0)) (pt-0 (4 3))
    (v (2 4)) (n (2 1))))</pre>

<p id="k2479">Item <a href="#t2117">2479</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='264.960' x2='939.600' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='489.960' x2='839.640' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='264.960' x2='739.680' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='114.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='189.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='489.960' x2='439.800' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='339.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='714.960' x2='139.920' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 489.960 Q 892.020 525.660 844.439 561.359'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='939.600' cy='264.960' r='6.000'/></g>
  <path
   d='M 839.640 639.960 Q 442.800 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <path
   d='M 739.680 339.960 Q 542.760 302.460 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <path
   d='M 639.720 339.960 Q 592.740 339.960 545.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 114.960 Q 442.800 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='639.720' cy='114.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 490.998 524.718 442.236 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 539.760 414.960 Q 736.680 377.460 933.600 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 714.960 Q 292.860 677.460 145.920 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='439.800' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 292.860 414.960 245.880 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 336.840 452.460 433.800 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 489.960 Q 536.760 452.460 833.640 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 264.960 Q 486.780 227.460 733.680 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 436.800 152.460 633.720 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='789.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2479 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 pcr-id-2 nonce-1 text)
    (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((2 1) (6 1)) ((2 2) (7 0)) ((2 4) (4 0)) ((2 4) (8 0))
    ((3 1) (2 3)) ((4 3) (1 0)) ((5 3) (4 2)) ((5 3) (9 2))
    ((6 0) (2 0)) ((6 3) (5 2)) ((7 1) (3 0)) ((8 2) (0 0))
    ((9 3) (8 1)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 nonce-1 n v pt pt-0 pt-2 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 10 6 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (9 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
          aik-0)))
    ((recv tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-3 (cat &quot;token&quot; nonce-1))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2479)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (6 0)) (pt-0 (6 3)) (nonce-1 (9 0)) (pt-2 (9 3))
    (n (2 1)) (k-0 (7 1)) (nonce-0 (5 0)) (pt (5 3)) (k (3 1))
    (v (2 4))))</pre>

<p id="k2480">Item <a href="#t2117">2480</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='489.960' x2='839.640' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='264.960' x2='739.680' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='114.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='264.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='489.960' x2='439.800' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='339.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='714.960' x2='139.920' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 742.680 377.460 545.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 939.600 414.960 Q 891.284 487.464 842.967 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 639.960 Q 442.800 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <path
   d='M 739.680 339.960 Q 542.760 302.460 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <path
   d='M 639.720 339.960 Q 786.660 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 114.960 Q 442.800 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='639.720' cy='114.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 491.444 562.464 443.127 634.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='264.960' r='6.000'/></g>
  <path
   d='M 439.800 714.960 Q 292.860 677.460 145.920 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='439.800' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 292.860 414.960 245.880 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 336.840 452.460 433.800 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 489.960 Q 536.760 452.460 833.640 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 264.960 Q 486.780 227.460 733.680 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 436.800 152.460 633.720 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='789.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2480 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 pcr-id-2 nonce-1 text)
    (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((2 1) (6 1)) ((2 2) (7 0)) ((2 4) (4 0)) ((2 4) (8 0))
    ((3 1) (2 3)) ((4 3) (1 0)) ((5 3) (4 2)) ((6 0) (2 0))
    ((6 3) (9 2)) ((7 1) (3 0)) ((8 2) (0 0)) ((9 3) (5 2))
    ((9 3) (8 1)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 nonce-1 n v pt pt-0 pt-2 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (rule ordered-extends)
  (operation channel-test (displaced 10 6 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (9 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
          aik-0)))
    ((recv tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-3 (cat &quot;token&quot; nonce-1))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2480)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (6 0)) (pt-0 (6 3)) (nonce-1 (9 0)) (pt-2 (9 3))
    (n (2 1)) (k-0 (7 1)) (nonce-0 (5 0)) (pt (5 3)) (k (3 1))
    (v (2 4))))</pre>

<p id="k2618">Item <a href="#t2117">2618</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='264.960' x2='939.600' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='564.960' x2='839.640' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='564.960' x2='639.720' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='264.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='789.960' x2='139.920' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 489.960 Q 891.284 562.464 842.967 634.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-4 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='939.600' cy='264.960' r='6.000'/></g>
  <path
   d='M 839.640 714.960 Q 442.800 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <path
   d='M 739.680 414.960 Q 690.648 562.114 641.617 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 739.680 414.960 Q 836.640 377.460 933.600 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot; (hash pcr-id-2 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 789.960 Q 392.820 752.460 145.920 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='564.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 442.800 377.460 345.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 486.780 339.960 533.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 342.840 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 489.960 Q 292.860 489.960 245.880 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 436.800 527.460 633.720 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 564.960 Q 536.760 527.460 833.640 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 336.840 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='864.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt-0) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2618 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 pcr-id-2 nonce-1 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))
  (precedes ((2 1) (4 1)) ((2 4) (6 0)) ((2 4) (8 0)) ((3 1) (2 3))
    ((4 0) (2 0)) ((4 3) (5 1)) ((4 3) (7 2)) ((5 2) (3 0))
    ((6 3) (1 0)) ((7 3) (6 2)) ((7 3) (9 2)) ((8 2) (0 0))
    ((9 3) (8 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt-0 pt-1 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation generalization deleted (4 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot;
          (hash pcr-id-2 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-4 (cat &quot;token&quot; nonce-2))
      (recv tpm-4
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2618)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt-0 (4 3)) (nonce-2 (9 0)) (pt-2 (9 3))
    (nonce-1 (7 0)) (pt-1 (7 3)) (k (3 1)) (v (2 4)) (n (2 1))))</pre>

<p id="k2619">Item <a href="#t2117">2619</a>, Parent: <a href="#k2117">2117</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='564.960' x2='839.640' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='264.960' x2='739.680' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='564.960' x2='639.720' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='264.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='789.960' x2='139.920' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 842.640 377.460 745.680 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 939.600 414.960 Q 890.838 524.718 842.076 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-4 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 714.960 Q 442.800 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <path
   d='M 739.680 489.960 Q 690.918 599.718 642.156 709.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot; (hash pcr-id-2 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='739.680' cy='264.960' r='6.000'/></g>
  <path
   d='M 639.720 789.960 Q 392.820 752.460 145.920 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='564.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 442.800 377.460 345.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 486.780 339.960 533.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 686.700 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 342.840 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 489.960 Q 292.860 489.960 245.880 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 436.800 527.460 633.720 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 564.960 Q 536.760 527.460 833.640 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 336.840 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='864.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt-0) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus 2619 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 pcr-id-2 nonce-1 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))
  (precedes ((2 1) (4 1)) ((2 4) (6 0)) ((2 4) (8 0)) ((3 1) (2 3))
    ((4 0) (2 0)) ((4 3) (5 1)) ((4 3) (9 2)) ((5 2) (3 0))
    ((6 3) (1 0)) ((7 3) (6 2)) ((8 2) (0 0)) ((9 3) (7 2))
    ((9 3) (8 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt-0 pt-1 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation generalization deleted (4 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot;
          (hash pcr-id-2 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-4 (cat &quot;token&quot; nonce-2))
      (recv tpm-4
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 2619)
  (parent 2117)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt-0 (4 3)) (nonce-2 (9 0)) (pt-2 (9 3))
    (nonce-1 (7 0)) (pt-1 (7 3)) (k (3 1)) (v (2 4)) (n (2 1))))</pre>

<p id="t3633">Tree <a href="#top">3633</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='379.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 379.920' font-size='12.000'>
  <text
   x='89.880' y='326.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k3791&quot;, &quot;_self&quot;)'>3791</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k3740&quot;, &quot;_self&quot;)'>3740</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k3711&quot;, &quot;_self&quot;)'>3711</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k3705&quot;, &quot;_self&quot;)'>3705</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k3687&quot;, &quot;_self&quot;)'>3687</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='176.040' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k3633&quot;, &quot;_self&quot;)'>3633</text>
  </svg></div>

<pre>(defprotocol envelope-plus-2 basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule pcr-id-identifies-pcr
    (forall ((y z strd) (pcr-id text) (pcr pcr-0 locn))
      (implies
        (and (p &quot;tpm-extend-enc&quot; y 3) (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;pcr-id&quot; y pcr-id)
          (p &quot;tpm-extend-enc&quot; &quot;pcr-id&quot; z pcr-id)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; y pcr)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; z pcr-0))
        (= pcr pcr-0)))))</pre>

<p id="k3633">Item <a href="#t3633">3633</a>, Children: <a href="#k3687">3687</a> <a href="#k3705">3705</a> <a href="#k3711">3711</a> <a href="#k3740">3740</a> <a href="#k3791">3791</a>.</p>

<div>
 <svg
  class='diagram' width='179.880pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 179.880 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='139.920' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='89.940' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 3633</text></svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id nonce text) (v n data) (k aik akey) (tpm tpmconf chan))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig v n)
  (conf tpmconf)
  (traces ((recv v) (send v))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 3633)
  (unrealized (0 0) (1 3))
  (preskeleton)
  (origs (v (1 4)) (n (1 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k3687">Item <a href="#t3633">3687</a>, Parent: <a href="#k3633">3633</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 864.960 Q 342.840 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 3687 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (nonce mesg) (pcr-id nonce-0 pcr-id-0 nonce-1 pcr-id-1 text)
    (v n data) (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (3 2)) ((5 2) (2 0)) ((6 3) (0 0)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 v n pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 7 3 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (6 2))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v)))
  (label 3687)
  (parent 3633)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-1 (3 0)) (pt-0 (3 3)) (k (2 1)) (nonce-0 (4 0))
    (pt (4 3)) (v (1 4)) (n (1 1))))</pre>

<p id="k3705">Item <a href="#t3633">3705</a>, Parent: <a href="#k3633">3633</a>.</p>

<div>
 <svg
  class='diagram' width='579.720pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 579.720 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='264.960' x2='239.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.484 487.464 343.167 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 192.900 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 339.960 Q 192.900 339.960 145.920 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 414.960 Q 236.880 377.460 333.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 186.900 264.960 233.880 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='289.860' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 3705 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id nonce pcr-id-0 nonce-0 text) (v n data)
    (pt pt-0 pt-1 pval) (k aik akey) (tpmconf tpm tpm-0 chan)
    (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt)
    (k k) (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (precedes ((1 1) (5 1)) ((1 2) (2 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 3) (0 0)) ((4 3) (3 2)) ((5 0) (1 0)) ((5 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 v n pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation encryption-test (contracted (tpm-1 tpmconf))
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (2 0)
    (ch-msg tpmconf
      (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n)))))
  (label 3705)
  (parent 3633)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (5 0)) (pt-0 (5 3)) (nonce-0 (4 0)) (pt (4 3)) (k (2 1))
    (n (1 1)) (v (1 4))))</pre>

<p id="k3711">Item <a href="#t3633">3711</a>, Parent: <a href="#k3633">3633</a>.</p>

<div>
 <svg
  class='diagram' width='779.640pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 779.640 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='864.960' x2='39.960' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 739.680 414.960 Q 690.473 599.561 641.265 784.162'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot; (hash pcr-id-2 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 864.960 Q 342.840 827.460 45.960 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='389.820' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 3711 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (nonce mesg)
    (pcr-id nonce-0 pcr-id-0 nonce-1 pcr-id-1 pcr-id-2 nonce-2 text)
    (v n data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-1)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (3 2)) ((4 3) (7 2)) ((5 2) (2 0))
    ((6 3) (0 0)) ((7 3) (6 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 v n pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 8 4 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (7 2))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot;
          (hash pcr-id-2 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))))
  (label 3711)
  (parent 3633)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt (4 3)) (nonce-2 (7 0)) (pt-2 (7 3))
    (k (2 1)) (nonce-1 (3 0)) (pt-0 (3 3)) (v (1 4)) (n (1 1))))</pre>

<p id="k3740">Item <a href="#t3633">3740</a>, Parent: <a href="#k3633">3633</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='264.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='339.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 339.960 Q 442.800 302.460 245.880 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.038 524.718 342.276 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot; (hash pcr-id-0 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 714.960 Q 192.900 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='339.840' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 192.900 414.960 145.920 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 489.960 Q 236.880 452.460 333.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 386.820 227.460 633.720 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 3740 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id nonce pcr-id-0 nonce-0 text) (v n data)
    (pt pt-0 pt-1 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt)
    (k k) (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k-0) (aik aik-0) (tpm tpmconf))
  (precedes ((1 1) (5 1)) ((1 2) (6 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 3) (0 0)) ((4 3) (3 2)) ((5 0) (1 0)) ((5 3) (4 2))
    ((6 1) (2 0)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 v n pt pt-0 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation encryption-test (displaced 7 1 alice 3)
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (6 0))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-0 &quot;obtain&quot;
          (hash pcr-id-0 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0))))
  (label 3740)
  (parent 3633)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (n (1 1)) (k-0 (6 1)) (nonce (5 0)) (pt-0 (5 3))
    (nonce-0 (4 0)) (pt (4 3)) (k (2 1)) (v (1 4))))</pre>

<p id="k3791">Item <a href="#t3633">3791</a>, Parent: <a href="#k3633">3633</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='189.960' x2='639.720' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='564.960' x2='539.760' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='114.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='414.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 414.960 Q 590.688 562.114 541.657 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 789.960 Q 292.860 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='539.760' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='539.760' cy='639.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='539.760' cy='564.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 342.840 377.460 245.880 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-0 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-0 nonce))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 386.820 339.960 433.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 339.840 339.960 Q 486.780 302.460 633.720 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle style='fill: blue;' cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 114.960 Q 242.880 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='339.840' cy='114.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 192.900 489.960 145.920 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 564.960 Q 336.840 527.460 533.760 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 236.880 152.460 333.840 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-0) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 3791 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (nonce mesg) (pcr-id nonce-0 pcr-id-0 pcr-id-1 nonce-1 text)
    (v n data) (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-0) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id)
    (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (3 1)) ((1 4) (5 0)) ((2 1) (1 3)) ((3 0) (1 0))
    ((3 3) (4 1)) ((3 3) (6 2)) ((4 2) (2 0)) ((5 3) (0 0))
    ((6 3) (5 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 v n pt-0 pt-1 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
  (conf tpmconf)
  (operation generalization deleted (3 0))
  (traces ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-0 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-0 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))))
  (label 3791)
  (parent 3633)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((v v) (n n) (pcr-id pcr-id) (nonce nonce-0) (k k) (aik aik)
        (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (3 0)) (pt-0 (3 3)) (nonce-1 (6 0)) (pt-1 (6 3))
    (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="t4021">Tree <a href="#top">4021</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='304.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 304.920' font-size='12.000'>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4137&quot;, &quot;_self&quot;)'>4137</text>
  <line
   x1='39.960' y1='152.460' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4099&quot;, &quot;_self&quot;)'>4099</text>
  <line
   x1='39.960' y1='152.460' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4078&quot;, &quot;_self&quot;)'>4078</text>
  <line
   x1='39.960' y1='152.460' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4073&quot;, &quot;_self&quot;)'>4073</text>
  <line
   x1='39.960' y1='152.460' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='138.540' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k4021&quot;, &quot;_self&quot;)'>4021</text>
  </svg></div>

<pre>(defprotocol envelope-plus-2 basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule pcr-id-identifies-pcr
    (forall ((y z strd) (pcr-id text) (pcr pcr-0 locn))
      (implies
        (and (p &quot;tpm-extend-enc&quot; y 3) (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;pcr-id&quot; y pcr-id)
          (p &quot;tpm-extend-enc&quot; &quot;pcr-id&quot; z pcr-id)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; y pcr)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; z pcr-0))
        (= pcr pcr-0)))))</pre>

<p id="k4021">Item <a href="#t4021">4021</a>, Children: <a href="#k4073">4073</a> <a href="#k4078">4078</a> <a href="#k4099">4099</a> <a href="#k4137">4137</a>.</p>

<div>
 <svg
  class='diagram' width='179.880pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 179.880 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='139.920' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='89.940' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4021</text></svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id pcr-id-0 nonce text) (n v data) (k aik akey)
    (tpm tpmconf chan))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig n v)
  (conf tpmconf)
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpm
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 4021)
  (unrealized (0 0) (1 3))
  (preskeleton)
  (origs (v (1 4)) (n (1 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k4073">Item <a href="#t4021">4073</a>, Parent: <a href="#k4021">4021</a>.</p>

<div>
 <svg
  class='diagram' width='579.720pt' height='679.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 579.720 679.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='264.960' x2='239.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='564.960' x2='39.960' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 392.220 450.660 344.639 486.359'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot; (hash pcr-id-1 &quot;refuse&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 192.900 527.460 45.960 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 339.960 Q 192.900 339.960 145.920 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 414.960 Q 236.880 377.460 333.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 186.900 264.960 233.880 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='564.960' r='6.000'/></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='339.840' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='289.860' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4073 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik akey) (tpmconf tpm tpm-0 chan)
    (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt)
    (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (precedes ((1 1) (5 1)) ((1 2) (2 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 2) (0 0)) ((4 3) (3 1)) ((5 0) (1 0)) ((5 3) (4 2)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 n v pt pt-0 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation encryption-test (contracted (tpm-1 tpmconf))
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (2 0)
    (ch-msg tpmconf
      (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot;
          (hash pcr-id-1 &quot;refuse&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n)))))
  (label 4073)
  (parent 4021)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (5 0)) (pt-0 (5 3)) (nonce-0 (4 0)) (pt (4 3)) (n (1 1))
    (k (2 1)) (v (1 4))))</pre>

<p id="k4078">Item <a href="#t4021">4078</a>, Parent: <a href="#k4021">4021</a>.</p>

<div>
 <svg
  class='diagram' width='779.640pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 779.640 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='639.960' x2='639.720' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='339.960' x2='539.760' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='189.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='489.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 739.680 414.960 Q 690.648 562.114 641.617 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 789.960 Q 342.840 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <path
   d='M 539.760 489.960 Q 392.820 452.460 245.880 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='539.760' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 392.820 339.960 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 292.860 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 436.800 377.460 533.760 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 192.900 564.960 145.920 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 639.960 Q 386.820 602.460 633.720 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 286.860 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='389.820' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4078 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((1 1) (4 1)) ((1 4) (6 0)) ((2 1) (1 3)) ((3 3) (5 1))
    ((4 0) (1 0)) ((4 3) (3 2)) ((4 3) (7 2)) ((5 2) (2 0))
    ((6 2) (0 0)) ((7 3) (6 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 8 4 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (7 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 4078)
  (parent 4021)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt (4 3)) (nonce-2 (7 0)) (pt-2 (7 3))
    (nonce-1 (3 0)) (pt-0 (3 3)) (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="k4099">Item <a href="#t4021">4099</a>, Parent: <a href="#k4021">4021</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='264.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='339.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 339.960 Q 442.800 302.460 245.880 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 342.840 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 391.484 487.464 343.167 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot; (hash pcr-id-1 &quot;refuse&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 639.960 Q 192.900 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='339.840' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 192.900 414.960 145.920 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 139.920 489.960 Q 236.880 452.460 333.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 264.960 Q 386.820 227.460 633.720 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='264.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 336.840 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='339.840' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4099 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt)
    (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))
  (precedes ((1 1) (5 1)) ((1 2) (6 0)) ((1 4) (3 0)) ((2 1) (1 3))
    ((3 2) (0 0)) ((4 3) (3 1)) ((5 0) (1 0)) ((5 3) (4 2))
    ((6 1) (2 0)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 n v pt pt-0 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation encryption-test (displaced 7 1 alice 3)
    (hash (hash &quot;0&quot; n) &quot;obtain&quot;) (6 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-1 &quot;refuse&quot;
          (hash pcr-id-1 &quot;refuse&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;refuse&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
          aik-0))))
  (label 4099)
  (parent 4021)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (n (1 1)) (k-0 (6 1)) (nonce (5 0)) (pt-0 (5 3))
    (nonce-0 (4 0)) (pt (4 3)) (k (2 1)) (v (1 4))))</pre>

<p id="k4137">Item <a href="#t4021">4137</a>, Parent: <a href="#k4021">4021</a>.</p>

<div>
 <svg
  class='diagram' width='679.680pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 679.680 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='639.720' y1='189.960' x2='639.720' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='564.960' x2='539.760' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='264.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='114.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='414.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 639.720 414.960 Q 590.958 524.718 542.196 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 714.960 Q 292.860 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='539.760' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='539.760' cy='564.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 342.840 377.460 245.880 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 386.820 339.960 433.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 339.840 339.960 Q 486.780 302.460 633.720 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='339.840' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 114.960 Q 242.880 77.460 145.920 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='339.840' cy='114.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 192.900 489.960 145.920 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 564.960 Q 336.840 527.460 533.760 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='139.920' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='139.920' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='139.920' cy='414.960' r='6.000'/></g>
  <path
   d='M 139.920 189.960 Q 236.880 152.460 333.840 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-1) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='239.880' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='139.920' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='339.840' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4137 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 pcr-id-2 nonce-1 text) (n v data)
    (pt pt-0 pt-1 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-1) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (precedes ((1 1) (3 1)) ((1 4) (5 0)) ((2 1) (1 3)) ((3 0) (1 0))
    ((3 3) (4 1)) ((3 3) (6 2)) ((4 2) (2 0)) ((5 2) (0 0))
    ((6 3) (5 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 n v pt-0 pt-1 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation generalization deleted (3 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 4137)
  (parent 4021)
  (unrealized)
  (shape)
  (maps
    ((0 1)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (3 0)) (pt-0 (3 3)) (nonce-1 (6 0)) (pt-1 (6 3))
    (k (2 1)) (v (1 4)) (n (1 1))))</pre>

<p id="t4223">Tree <a href="#top">4223</a>.</p>

<div>
 <svg
  class='diagram' width='129.840pt' height='379.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 129.840 379.920' font-size='12.000'>
  <text
   x='89.880' y='326.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4595&quot;, &quot;_self&quot;)'>4595</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='251.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4518&quot;, &quot;_self&quot;)'>4518</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='264.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='176.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4452&quot;, &quot;_self&quot;)'>4452</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='101.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4413&quot;, &quot;_self&quot;)'>4413</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='114.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='89.880' y='26.040' style='text-anchor: middle; fill: blue;'
   onclick='window.open(&quot;#k4389&quot;, &quot;_self&quot;)'>4389</text>
  <line
   x1='39.960' y1='189.960' x2='89.880' y2='39.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <text
   x='39.960' y='176.040' style='text-anchor: middle; fill: black;'
   onclick='window.open(&quot;#k4223&quot;, &quot;_self&quot;)'>4223</text>
  </svg></div>

<pre>(defprotocol envelope-plus-2 basic
  (defrole tpm-power-on
    (vars (current-value mesg) (pcr locn) (tpm chan) (pt pt-0 pval))
    (trace (recv tpm &quot;power on&quot;) (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 &quot;0&quot;)))
    (uniq-orig pt-0))
  (defrole tpm-extend-enc
    (vars (value current-value mesg) (pcr-id nonce text) (pcr locn)
      (tpm chan) (pt pt-0 pval))
    (trace (send tpm (cat &quot;token&quot; nonce))
      (recv tpm (cat &quot;extend&quot; pcr-id value (hash pcr-id value nonce)))
      (load pcr (cat pt current-value))
      (stor pcr (cat pt-0 (hash current-value value))) (send &quot;ext ok&quot;))
    (uniq-orig nonce pt-0))
  (defrole tpm-quote
    (vars (nonce current-value mesg) (pcr-id text) (aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;quote&quot; pcr-id nonce))
      (load pcr (cat pt current-value))
      (send (enc &quot;quote&quot; pcr-id current-value nonce aik))))
  (defrole tpm-create-key
    (vars (k aik akey) (pcr-id text) (pcrval mesg) (tpm chan))
    (trace (recv tpm (cat &quot;create-req&quot; pcr-id pcrval))
      (send (enc &quot;created&quot; k pcr-id pcrval aik)))
    (non-orig (invk k))
    (uniq-orig k))
  (defrole tpm-decrypt
    (vars (m current-value mesg) (pcr-id text) (k aik akey) (pcr locn)
      (tpm chan) (pt pval))
    (trace (recv tpm (cat &quot;decrypt&quot; (enc m k)))
      (recv (enc &quot;created&quot; k pcr-id current-value aik))
      (load pcr (cat pt current-value)) (send m))
    (non-orig aik))
  (defrole alice
    (vars (n v data) (pcr-id nonce text) (k aik akey)
      (tpm tpmconf chan))
    (trace (recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id n (hash pcr-id n nonce)))
      (send tpm (cat &quot;create-req&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    (non-orig aik)
    (uniq-orig n v)
    (conf tpmconf)
    (neq (k aik)))
  (defrule genStV-if-hashed-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-if-hashed-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (hash v1 v2)))
        (gen-st (hash v1 v2)))))
  (defrule genStV-not-catted-tpm-power-on
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-power-on&quot; z 2)
          (p &quot;tpm-power-on&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-extend-enc
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-extend-enc&quot; z 2)
          (p &quot;tpm-extend-enc&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-decrypt
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-decrypt&quot; z 3)
          (p &quot;tpm-decrypt&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule genStV-not-catted-tpm-quote
    (forall ((z strd) (v1 v2 mesg))
      (implies
        (and (p &quot;tpm-quote&quot; z 2)
          (p &quot;tpm-quote&quot; &quot;current-value&quot; z (cat v1 v2)))
        (false))))
  (defrule pcr-id-identifies-pcr
    (forall ((y z strd) (pcr-id text) (pcr pcr-0 locn))
      (implies
        (and (p &quot;tpm-extend-enc&quot; y 3) (p &quot;tpm-extend-enc&quot; z 3)
          (p &quot;tpm-extend-enc&quot; &quot;pcr-id&quot; y pcr-id)
          (p &quot;tpm-extend-enc&quot; &quot;pcr-id&quot; z pcr-id)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; y pcr)
          (p &quot;tpm-extend-enc&quot; &quot;pcr&quot; z pcr-0))
        (= pcr pcr-0)))))</pre>

<p id="k4223">Item <a href="#t4223">4223</a>, Children: <a href="#k4389">4389</a> <a href="#k4413">4413</a> <a href="#k4452">4452</a> <a href="#k4518">4518</a> <a href="#k4595">4595</a>.</p>

<div>
 <svg
  class='diagram' width='279.840pt' height='454.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 279.840 454.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='114.960' x2='139.920' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='114.960' x2='39.960' y2='189.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: red;' cx='239.880' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='189.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: red;' cx='139.920' cy='114.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='189.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: red;' cx='39.960' cy='114.960' r='6.000'/></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpm) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='139.920' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4223</text></svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id pcr-id-0 nonce text) (n v data) (k aik akey)
    (tpm tpmconf chan))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpm) (tpmconf tpmconf))
  (non-orig aik)
  (uniq-orig n v)
  (conf tpmconf)
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpm (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpm
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k))))
  (label 4223)
  (unrealized (0 0) (1 0) (2 3))
  (preskeleton)
  (origs (v (2 4)) (n (2 1)))
  (comment &quot;Not a skeleton&quot;))</pre>

<p id="k4389">Item <a href="#t4223">4389</a>, Parent: <a href="#k4223">4223</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='639.960' x2='839.640' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='639.960' x2='739.680' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='339.960' x2='639.720' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='864.960' x2='139.920' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 890.568 562.114 841.537 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-4 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 789.960 Q 442.800 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='639.960' r='6.000'/></g>
  <path
   d='M 739.680 864.960 Q 442.800 827.460 145.920 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='639.960' r='6.000'/></g>
  <path
   d='M 639.720 489.960 Q 492.780 452.460 345.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 539.760 339.960 Q 736.680 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 536.760 377.460 633.720 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 292.860 564.960 245.880 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 486.780 602.460 733.680 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 639.960 Q 536.760 602.460 833.640 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4389 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-0) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (8 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((5 0) (2 0)) ((5 3) (4 2)) ((5 3) (9 2))
    ((6 2) (3 0)) ((7 3) (1 0)) ((8 2) (0 0)) ((9 3) (8 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 10 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (9 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((recv tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-4 (cat &quot;token&quot; nonce-2))
      (recv tpm-4
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 4389)
  (parent 4223)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-2 (9 0)) (pt-2 (9 3))
    (nonce-1 (4 0)) (pt-0 (4 3)) (k (3 1)) (v (2 4)) (n (2 1))))</pre>

<p id="k4413">Item <a href="#t4223">4413</a>, Parent: <a href="#k4223">4223</a>.</p>

<div>
 <svg
  class='diagram' width='879.600pt' height='754.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 879.600 754.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='839.640' y1='189.960' x2='839.640' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='414.960' x2='739.680' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='114.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='189.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='414.960' x2='439.800' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='264.960' x2='339.840' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='639.960' x2='139.920' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='564.960' x2='39.960' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 839.640 414.960 Q 792.060 450.660 744.479 486.359'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='839.640' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='839.640' cy='189.960' r='6.000'/></g>
  <path
   d='M 739.680 564.960 Q 392.820 527.460 45.960 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='739.680' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <path
   d='M 639.720 339.960 Q 592.740 339.960 545.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 639.720 339.960 Q 736.680 302.460 833.640 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 114.960 Q 442.800 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='639.720' cy='114.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 491.444 487.464 443.127 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 639.960 Q 292.860 602.460 145.920 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='439.800' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <g><title>(ch-msg tpm (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <path
   d='M 339.840 339.960 Q 292.860 339.960 245.880 339.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 414.960 Q 336.840 377.460 433.800 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 414.960 Q 486.780 377.460 733.680 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='339.960' r='6.000'/></g>
  <path
   d='M 239.880 264.960 Q 286.860 264.960 333.840 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 436.800 152.460 633.720 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='714.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='564.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-2) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='739.680' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='439.800' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4413 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 pcr-id-2 nonce-1 text)
    (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpmconf))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt) (k k) (aik aik) (tpm tpm) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-2) (pcr pcr))
  (precedes ((2 1) (6 1)) ((2 2) (3 0)) ((2 4) (4 0)) ((2 4) (7 0))
    ((3 1) (2 3)) ((4 3) (1 0)) ((5 3) (4 2)) ((6 0) (2 0))
    ((6 3) (5 2)) ((6 3) (8 2)) ((7 2) (0 0)) ((8 3) (7 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce nonce-0 nonce-1 n v pt pt-0 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 9 6 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (8 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-0 (cat &quot;token&quot; nonce-0))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 4413)
  (parent 4223)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (6 0)) (pt-0 (6 3)) (nonce-1 (8 0)) (pt-2 (8 3))
    (nonce-0 (5 0)) (pt (5 3)) (k (3 1)) (n (2 1)) (v (2 4))))</pre>

<p id="k4452">Item <a href="#t4223">4452</a>, Parent: <a href="#k4223">4223</a>.</p>

<div>
 <svg
  class='diagram' width='1079.520pt' height='979.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 1079.520 979.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='1039.560' y1='189.960' x2='1039.560' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='939.600' y1='639.960' x2='939.600' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='189.960' x2='839.640' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='639.960' x2='739.680' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='339.960' x2='639.720' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='114.960' x2='539.760' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='189.960' x2='439.800' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='489.960' x2='339.840' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='864.960' x2='139.920' y2='939.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='789.960' x2='39.960' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 1039.560 414.960 Q 990.528 562.114 941.497 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='414.960' r='6.000'/>
   </g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='339.960' r='6.000'/>
   </g>
  <g>
   <title>(ch-msg tpm-5 (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot; (hash pcr-id-4 &quot;refuse&quot; nonce-3)))</title>
   <circle style='fill: blue;' cx='1039.560' cy='264.960' r='6.000'/>
   </g>
  <g><title>(ch-msg tpm-5 (cat &quot;token&quot; nonce-3))</title>
   <circle cx='1039.560' cy='189.960' r='6.000'/></g>
  <path
   d='M 939.600 789.960 Q 492.780 752.460 45.960 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='939.600' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='939.600' cy='639.960' r='6.000'/></g>
  <path
   d='M 839.640 414.960 Q 790.433 599.561 741.225 784.162'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='839.640' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot; (hash pcr-id-3 &quot;obtain&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='839.640' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='839.640' cy='189.960' r='6.000'/></g>
  <path
   d='M 739.680 864.960 Q 442.800 827.460 145.920 864.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='739.680' cy='864.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='739.680' cy='714.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='739.680' cy='639.960' r='6.000'/></g>
  <path
   d='M 639.720 489.960 Q 492.780 452.460 345.840 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce aik-0)</title>
   <circle cx='639.720' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <path
   d='M 539.760 339.960 Q 492.780 339.960 445.800 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 539.760 339.960 Q 686.700 302.460 833.640 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 539.760 339.960 Q 786.660 302.460 1033.560 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 539.760 114.960 Q 392.820 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='114.960' r='6.000'/></g>
  <path
   d='M 439.800 414.960 Q 536.760 377.460 633.720 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 339.840 564.960 Q 292.860 564.960 245.880 564.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 639.960 Q 486.780 602.460 733.680 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 639.960 Q 586.740 602.460 933.600 639.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 386.820 152.460 533.760 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='939.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='864.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3) (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))</title>
   <text
    x='1039.560' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2) (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1) (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='539.760' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4452 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 nonce-1 pcr-id-2 pcr-id-3 nonce-2
      pcr-id-4 nonce-3 text) (n v data) (pt pt-0 pt-1 pt-2 pt-3 pval)
    (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 tpm-5 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-1)
    (pt pt) (pt-0 pt-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt-1) (pt-0 pt) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-2)
    (pt pt-0) (aik aik-0) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-2) (k k) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-3) (aik aik) (tpm tpm-4) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-4) (nonce nonce-3)
    (pt pt) (pt-0 pt-3) (tpm tpm-5) (pcr pcr))
  (precedes ((2 1) (5 1)) ((2 4) (7 0)) ((2 4) (9 0)) ((3 1) (2 3))
    ((4 3) (6 1)) ((5 0) (2 0)) ((5 3) (4 2)) ((5 3) (8 2))
    ((5 3) (10 2)) ((6 2) (3 0)) ((7 3) (1 0)) ((8 3) (7 2))
    ((9 2) (0 0)) ((10 3) (9 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 nonce-3 n v pt pt-0 pt-2 pt-3 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 11 5 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-4 (hash &quot;0&quot; n))) (10 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpm-0 (cat &quot;token&quot; nonce-1))
      (recv tpm-0
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt (hash &quot;0&quot; n))))
    ((recv tpm-1 (cat &quot;quote&quot; pcr-id-2 nonce))
      (load pcr (cat pt-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) nonce
          aik-0)))
    ((recv tpm-2 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-3 (cat &quot;token&quot; nonce-2))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-3 &quot;obtain&quot;
          (hash pcr-id-3 &quot;obtain&quot; nonce-2)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-4 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-5 (cat &quot;token&quot; nonce-3))
      (recv tpm-5
        (cat &quot;extend&quot; pcr-id-4 &quot;refuse&quot;
          (hash pcr-id-4 &quot;refuse&quot; nonce-3)))
      (load pcr (cat pt (hash &quot;0&quot; n)))
      (stor pcr (cat pt-3 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 4452)
  (parent 4223)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (5 0)) (pt (5 3)) (nonce-3 (10 0)) (pt-3 (10 3))
    (nonce-2 (8 0)) (pt-2 (8 3)) (k (3 1)) (nonce-1 (4 0)) (pt-0 (4 3))
    (v (2 4)) (n (2 1))))</pre>

<p id="k4518">Item <a href="#t4223">4518</a>, Parent: <a href="#k4223">4223</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='829.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 829.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='489.960' x2='839.640' y2='639.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='264.960' x2='739.680' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='114.960' x2='639.720' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='189.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='489.960' x2='439.800' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='339.960' x2='339.840' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='714.960' x2='139.920' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='639.960' x2='39.960' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 891.284 487.464 842.967 559.967'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot; (hash pcr-id-2 &quot;refuse&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-3 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 639.960 Q 442.800 602.460 45.960 639.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='489.960' r='6.000'/></g>
  <path
   d='M 739.680 339.960 Q 542.760 302.460 345.840 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik-0)</title>
   <circle cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <path
   d='M 639.720 339.960 Q 592.740 339.960 545.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 639.720 339.960 Q 786.660 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='639.720' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-1 &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='639.720' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle style='fill: blue;' cx='639.720' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 114.960 Q 442.800 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle cx='639.720' cy='114.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 490.998 524.718 442.236 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-1 (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot; (hash pcr-id-1 &quot;obtain&quot; nonce-0)))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;token&quot; nonce-0))</title>
   <circle cx='539.760' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 714.960 Q 292.860 677.460 145.920 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='439.800' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='439.800' cy='639.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='439.800' cy='564.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-0 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='439.800' cy='489.960' r='6.000'/></g>
  <path
   d='M 339.840 414.960 Q 292.860 414.960 245.880 414.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='414.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='339.960' r='6.000'/></g>
  <path
   d='M 239.880 489.960 Q 336.840 452.460 433.800 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 489.960 Q 536.760 452.460 833.640 489.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 264.960 Q 486.780 227.460 733.680 264.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='264.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 436.800 152.460 633.720 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='789.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='639.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0) (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='539.760' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4518 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (pcr-id pcr-id-0 nonce pcr-id-1 nonce-0 pcr-id-2 nonce-1 text)
    (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik k-0 aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt) (k k) (aik aik) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (nonce nonce-0)
    (pt pt-0) (pt-0 pt) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce) (pt pt-1) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k-0) (aik aik-0) (tpm tpmconf))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-3) (pcr pcr))
  (precedes ((2 1) (6 1)) ((2 2) (7 0)) ((2 4) (4 0)) ((2 4) (8 0))
    ((3 1) (2 3)) ((4 3) (1 0)) ((5 3) (4 2)) ((6 0) (2 0))
    ((6 3) (5 2)) ((6 3) (9 2)) ((7 1) (3 0)) ((8 2) (0 0))
    ((9 3) (8 1)))
  (non-orig aik (invk k) (invk k-0))
  (uniq-orig nonce nonce-0 nonce-1 n v pt pt-0 pt-2 k k-0)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation channel-test (displaced 10 6 tpm-extend-enc 4)
    (ch-msg pcr-0 (cat pt-3 (hash &quot;0&quot; n))) (9 2))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((recv tpm-0 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-1 (cat &quot;token&quot; nonce-0))
      (recv tpm-1
        (cat &quot;extend&quot; pcr-id-1 &quot;obtain&quot;
          (hash pcr-id-1 &quot;obtain&quot; nonce-0)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((send tpmconf (cat &quot;token&quot; nonce))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce)))
      (load pcr (cat pt-1 &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpmconf
       (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k-0 pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
          aik-0)))
    ((recv tpm-2 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-3 (cat &quot;token&quot; nonce-1))
      (recv tpm-3
        (cat &quot;extend&quot; pcr-id-2 &quot;refuse&quot;
          (hash pcr-id-2 &quot;refuse&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 4518)
  (parent 4223)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce (6 0)) (pt-0 (6 3)) (nonce-1 (9 0)) (pt-2 (9 3))
    (n (2 1)) (k-0 (7 1)) (nonce-0 (5 0)) (pt (5 3)) (k (3 1))
    (v (2 4))))</pre>

<p id="k4595">Item <a href="#t4223">4595</a>, Parent: <a href="#k4223">4223</a>.</p>

<div>
 <svg
  class='diagram' width='979.560pt' height='904.920pt'
  xmlns='http://www.w3.org/2000/svg' version='1.1'
  viewBox='0 0 979.560 904.920' font-size='12.000'>
  <defs>
   <marker
    id='arrow' orient='auto' markerWidth='5' markerHeight='10' refX='5'
    refY='5'>
    <path
     d='M 0 0 5 5 0 10'
     style='stroke-width: 2; fill: none; stroke: black;'/></marker>
   </defs>
  <line
   x1='939.600' y1='189.960' x2='939.600' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='839.640' y1='564.960' x2='839.640' y2='714.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='739.680' y1='189.960' x2='739.680' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='639.720' y1='564.960' x2='639.720' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='539.760' y1='264.960' x2='539.760' y2='414.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='439.800' y1='114.960' x2='439.800' y2='339.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='339.840' y1='414.960' x2='339.840' y2='489.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='239.880' y1='114.960' x2='239.880' y2='564.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='139.920' y1='789.960' x2='139.920' y2='864.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <line
   x1='39.960' y1='714.960' x2='39.960' y2='789.960'
   style='stroke-width: 0.960; stroke: gray;'/>
  <path
   d='M 939.600 414.960 Q 890.838 524.718 842.076 634.477'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='939.600' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='939.600' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-4 (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot; (hash pcr-id-3 &quot;refuse&quot; nonce-2)))</title>
   <circle style='fill: blue;' cx='939.600' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-4 (cat &quot;token&quot; nonce-2))</title>
   <circle cx='939.600' cy='189.960' r='6.000'/></g>
  <path
   d='M 839.640 714.960 Q 442.800 677.460 45.960 714.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='839.640' cy='714.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))</title>
   <circle style='fill: blue;' cx='839.640' cy='639.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))</title>
   <circle style='fill: blue;' cx='839.640' cy='564.960' r='6.000'/></g>
  <path
   d='M 739.680 414.960 Q 690.648 562.114 641.617 709.268'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='739.680' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='739.680' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-2 (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot; (hash pcr-id-2 &quot;obtain&quot; nonce-1)))</title>
   <circle style='fill: blue;' cx='739.680' cy='264.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-2 (cat &quot;token&quot; nonce-1))</title>
   <circle cx='739.680' cy='189.960' r='6.000'/></g>
  <path
   d='M 639.720 789.960 Q 392.820 752.460 145.920 789.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>v</title><circle cx='639.720' cy='789.960' r='6.000'/></g>
  <g>
   <title>(ch-msg pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='639.720' cy='714.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='639.720' cy='639.960' r='6.000'/></g>
  <g><title>(ch-msg tpm-1 (cat &quot;decrypt&quot; (enc v k)))</title>
   <circle style='fill: blue;' cx='639.720' cy='564.960' r='6.000'/></g>
  <path
   d='M 539.760 414.960 Q 442.800 377.460 345.840 414.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)</title>
   <circle cx='539.760' cy='414.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='539.760' cy='339.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))</title>
   <circle style='fill: blue;' cx='539.760' cy='264.960' r='6.000'/></g>
  <path
   d='M 439.800 339.960 Q 486.780 339.960 533.760 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 586.740 302.460 733.680 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 439.800 339.960 Q 686.700 302.460 933.600 339.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg pcr (cat pt-0 (hash &quot;0&quot; n)))</title>
   <circle style='fill: blue;' cx='439.800' cy='339.960' r='6.000'/></g>
  <g><title>(ch-msg pcr (cat pt &quot;0&quot;))</title>
   <circle style='fill: blue;' cx='439.800' cy='264.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle style='fill: blue;' cx='439.800' cy='189.960' r='6.000'/></g>
  <path
   d='M 439.800 114.960 Q 342.840 77.460 245.880 114.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle cx='439.800' cy='114.960' r='6.000'/></g>
  <path
   d='M 339.840 489.960 Q 292.860 489.960 245.880 489.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle cx='339.840' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle style='fill: blue;' cx='339.840' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 564.960 Q 436.800 527.460 633.720 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <path
   d='M 239.880 564.960 Q 536.760 527.460 833.640 564.960'
   style='stroke-dasharray: 6.000,2.400; stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g><title>(enc v k)</title>
   <circle cx='239.880' cy='564.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)</title>
   <circle style='fill: blue;' cx='239.880' cy='489.960' r='6.000'/></g>
  <g>
   <title>(ch-msg tpmconf (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))</title>
   <circle cx='239.880' cy='414.960' r='6.000'/></g>
  <path
   d='M 239.880 189.960 Q 336.840 152.460 433.800 189.960'
   style='stroke-width: 0.960; stroke: black; marker-end: url(#arrow); fill: none;'/>
  <g>
   <title>(ch-msg tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))</title>
   <circle cx='239.880' cy='189.960' r='6.000'/></g>
  <g><title>(ch-msg tpmconf (cat &quot;token&quot; nonce-0))</title>
   <circle style='fill: blue;' cx='239.880' cy='114.960' r='6.000'/></g>
  <g><title>v</title><circle cx='139.920' cy='864.960' r='6.000'/></g>
  <g><title>v</title>
   <circle style='fill: blue;' cx='139.920' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle cx='39.960' cy='789.960' r='6.000'/></g>
  <g>
   <title>(enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik)</title>
   <circle style='fill: blue;' cx='39.960' cy='714.960' r='6.000'/></g>
  <g>
   <title>((value &quot;refuse&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2) (pt pt-0) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))</title>
   <text
    x='939.600' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((nonce (enc v k)) (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id) (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))</title>
   <text
    x='839.640' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value &quot;obtain&quot;) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1) (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))</title>
   <text
    x='739.680' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((m v) (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))</title>
   <text
    x='639.720' y='77.460'
    style='text-anchor: middle;'>tpm-decrypt</text></g>
  <g>
   <title>((nonce nonce) (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))</title>
   <text
    x='539.760' y='77.460' style='text-anchor: middle;'>tpm-quote</text>
   </g>
  <g>
   <title>((value n) (current-value &quot;0&quot;) (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf) (pcr pcr))</title>
   <text
    x='439.800' y='77.460'
    style='text-anchor: middle;'>tpm-extend-enc</text></g>
  <g>
   <title>((pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))</title>
   <text
    x='339.840' y='77.460'
    style='text-anchor: middle;'>tpm-create-key</text></g>
  <g>
   <title>((pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k) (aik aik) (tpm tpmconf) (tpmconf tpmconf))</title>
   <text
    x='239.880' y='77.460' style='text-anchor: middle;'>alice</text></g>
  <text
   x='489.780' y='39.960'
   style='text-anchor: middle;'>envelope-plus-2 4595 (realized)</text>
  </svg></div>

<pre>(defskeleton envelope-plus-2
  (vars (nonce mesg)
    (pcr-id pcr-id-0 nonce-0 pcr-id-1 pcr-id-2 nonce-1 pcr-id-3 nonce-2
      text) (n v data) (pt pt-0 pt-1 pt-2 pval) (k aik aik-0 akey)
    (tpmconf tpm tpm-0 tpm-1 tpm-2 tpm-3 tpm-4 chan) (pcr locn))
  (deflistener
    (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
  (deflistener v)
  (defstrand alice 5 (pcr-id pcr-id-0) (nonce nonce-0) (n n) (v v) (k k)
    (aik aik) (tpm tpmconf) (tpmconf tpmconf))
  (defstrand tpm-create-key 2 (pcrval (hash (hash &quot;0&quot; n) &quot;obtain&quot;))
    (pcr-id pcr-id-0) (k k) (aik aik) (tpm tpm))
  (defstrand tpm-extend-enc 4 (value n) (current-value &quot;0&quot;)
    (pcr-id pcr-id-0) (nonce nonce-0) (pt pt) (pt-0 pt-0) (tpm tpmconf)
    (pcr pcr))
  (defstrand tpm-quote 3 (nonce nonce) (current-value (hash &quot;0&quot; n))
    (pcr-id pcr-id-1) (pt pt-0) (aik aik-0) (tpm tpm-0) (pcr pcr))
  (defstrand tpm-decrypt 4 (m v)
    (current-value (hash (hash &quot;0&quot; n) &quot;obtain&quot;)) (pcr-id pcr-id-0)
    (pt pt-1) (k k) (aik aik) (tpm tpm-1) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;obtain&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-2) (nonce nonce-1)
    (pt pt-0) (pt-0 pt-1) (tpm tpm-2) (pcr pcr))
  (defstrand tpm-quote 3 (nonce (enc v k))
    (current-value (hash (hash &quot;0&quot; n) &quot;refuse&quot;)) (pcr-id pcr-id)
    (pt pt-2) (aik aik) (tpm tpm-3) (pcr pcr))
  (defstrand tpm-extend-enc 4 (value &quot;refuse&quot;)
    (current-value (hash &quot;0&quot; n)) (pcr-id pcr-id-3) (nonce nonce-2)
    (pt pt-0) (pt-0 pt-2) (tpm tpm-4) (pcr pcr))
  (precedes ((2 1) (4 1)) ((2 4) (6 0)) ((2 4) (8 0)) ((3 1) (2 3))
    ((4 0) (2 0)) ((4 3) (5 1)) ((4 3) (7 2)) ((4 3) (9 2))
    ((5 2) (3 0)) ((6 3) (1 0)) ((7 3) (6 2)) ((8 2) (0 0))
    ((9 3) (8 1)))
  (non-orig aik (invk k))
  (uniq-orig nonce-0 nonce-1 nonce-2 n v pt-0 pt-1 pt-2 k)
  (genStV (hash &quot;0&quot; n) (hash (hash &quot;0&quot; n) &quot;obtain&quot;)
    (hash (hash &quot;0&quot; n) &quot;refuse&quot;))
  (conf tpmconf)
  (operation generalization deleted (4 0))
  (traces
    ((recv
       (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k) aik))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik))) ((recv v) (send v))
    ((recv tpmconf (cat &quot;token&quot; nonce-0))
      (send tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (send tpmconf
        (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (send (enc v k)))
    ((recv tpm (cat &quot;create-req&quot; pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;)))
      (send
        (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik)))
    ((send tpmconf (cat &quot;token&quot; nonce-0))
      (recv tpmconf (cat &quot;extend&quot; pcr-id-0 n (hash pcr-id-0 n nonce-0)))
      (load pcr (cat pt &quot;0&quot;)) (stor pcr (cat pt-0 (hash &quot;0&quot; n))))
    ((recv tpm-0 (cat &quot;quote&quot; pcr-id-1 nonce))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (send (enc &quot;quote&quot; pcr-id-1 (hash &quot;0&quot; n) nonce aik-0)))
    ((recv tpm-1 (cat &quot;decrypt&quot; (enc v k)))
      (recv (enc &quot;created&quot; k pcr-id-0 (hash (hash &quot;0&quot; n) &quot;obtain&quot;) aik))
      (load pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))) (send v))
    ((send tpm-2 (cat &quot;token&quot; nonce-1))
      (recv tpm-2
        (cat &quot;extend&quot; pcr-id-2 &quot;obtain&quot;
          (hash pcr-id-2 &quot;obtain&quot; nonce-1)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-1 (hash (hash &quot;0&quot; n) &quot;obtain&quot;))))
    ((recv tpm-3 (cat &quot;quote&quot; pcr-id (enc v k)))
      (load pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))
      (send
        (enc &quot;quote&quot; pcr-id (hash (hash &quot;0&quot; n) &quot;refuse&quot;) (enc v k)
          aik)))
    ((send tpm-4 (cat &quot;token&quot; nonce-2))
      (recv tpm-4
        (cat &quot;extend&quot; pcr-id-3 &quot;refuse&quot;
          (hash pcr-id-3 &quot;refuse&quot; nonce-2)))
      (load pcr (cat pt-0 (hash &quot;0&quot; n)))
      (stor pcr (cat pt-2 (hash (hash &quot;0&quot; n) &quot;refuse&quot;)))))
  (label 4595)
  (parent 4223)
  (unrealized)
  (shape)
  (maps
    ((0 1 2)
      ((n n) (v v) (k k) (aik aik) (pcr-id pcr-id) (pcr-id-0 pcr-id-0)
        (nonce nonce-0) (tpm tpmconf) (tpmconf tpmconf))))
  (origs (nonce-0 (4 0)) (pt-0 (4 3)) (nonce-2 (9 0)) (pt-2 (9 3))
    (nonce-1 (7 0)) (pt-1 (7 3)) (k (3 1)) (v (2 4)) (n (2 1))))</pre>

</body>
</html>
